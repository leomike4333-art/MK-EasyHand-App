<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MK EasyHand App</title>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
      --ok:#16a34a; --bad:#dc2626; --blue:#2563eb; --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:28px}
    .sub{margin-top:6px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .in{padding:14px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--muted);font-size:12px}
    .btn{
      border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;
      background:#111827;color:#fff
    }
    .btn.secondary{background:#374151}
    .btn.blue{background:var(--blue)}
    .btn.green{background:var(--ok)}
    .btn.red{background:var(--bad)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    select,input[type="number"],input[type="text"]{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff
    }
    input[type="file"]{padding:8px;border-radius:12px;border:1px solid var(--border);background:#fff}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .small{font-size:12px;color:var(--muted)}
    .status{
      font-weight:800;display:inline-flex;align-items:center;gap:10px;
      padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#fff
    }
    .status.ok{color:var(--ok)}
    .status.bad{color:var(--bad)}
    .imgBox{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff}
    #imgPreview{display:none;max-width:100%;height:auto;cursor:crosshair}
    .clickline{margin-top:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    textarea{
      width:100%;min-height:130px;border:1px solid var(--border);border-radius:14px;padding:10px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace
    }
    .hands{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.hands{grid-template-columns:1fr}}
    .handcard{border:1px solid var(--border);border-radius:16px;background:#fff}
    .handcard .title{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:900}
    .handcard .body{padding:12px}
    .suitRow{display:grid;grid-template-columns:24px 1fr;gap:10px;align-items:center;margin:8px 0}
    .suitIcon{font-size:18px}
    .s{color:#2563eb} .h{color:#dc2626} .d{color:#f59e0b} .c{color:#16a34a}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.twoCols{grid-template-columns:1fr}}
    .hint{margin-top:10px;padding:10px;border:1px dashed var(--border);border-radius:14px;background:#fff;color:var(--muted)}
    .kbd{font-family:ui-monospace;background:#f3f4f6;border:1px solid #e5e7eb;padding:2px 6px;border-radius:8px;color:#111827}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>MK EasyHand App</h1>
    <div class="sub">Screenshot ‚Üí Paste / Upload ‚Üí <b>Click a suit symbol</b> ‚Üí Generate LIN ‚Üí Open Solver / BBO</div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="in">
      <div class="row">
        <label><b>Source:</b></label>
        <select id="sourceSel">
          <option value="A">A ‚Äì RealBridge</option>
          <option value="B">B ‚Äì BBO</option>
          <option value="C" selected>C ‚Äì Federation / Local (FIGB)</option>
          <option value="D">D ‚Äì LoveBridge / WBF</option>
        </select>

        <button class="btn blue" id="pasteBtn">üìã Paste</button>
        <input type="file" id="fileInput" accept="image/*">

        <span id="imgMsg" class="pill">No image yet.</span>

        <span class="status bad" id="statusBadge">Validation: KO ‚úñ</span>

        <button class="btn green" id="genBtn">Generate LIN/PBN (validate)</button>
      </div>

      <div class="hint">
        <b>FIGB mode (Source C):</b> paste/upload ‚Üí <b>click directly on a suit icon</b> (‚ô†/‚ô•/‚ô¶/‚ô£) near the hand you want to read.
        OCR is ‚Äúrestricted‚Äù (only AKQJT98765432, 10‚ÜíT).<br/>
        Tip: If needed, use <span class="kbd">Ctrl+F5</span> or add <span class="kbd">?v=123</span> to your URL to bypass cache.
      </div>
    </div>
  </div>

  <div style="height:14px"></div>

  <div class="grid">
    <!-- LEFT: image -->
    <div class="card">
      <div class="in">
        <div class="imgBox">
          <img id="imgPreview" alt="preview">
        </div>
        <div class="clickline small mono" id="clickMsg"></div>
        <div class="small" style="margin-top:8px">
          <b>Status:</b> <span id="flowMsg">Paste or upload an image.</span>
        </div>
      </div>
    </div>

    <!-- RIGHT: debug + outputs -->
    <div class="card">
      <div class="in">
        <div class="small"><b>Debug</b> (last run)</div>
        <textarea id="debugOut" readonly class="mono" style="min-height:160px"></textarea>

        <div style="height:10px"></div>

        <div class="twoCols">
          <div>
            <div class="small"><b>LIN output</b></div>
            <textarea id="linOut" readonly class="mono"></textarea>
            <div class="row" style="margin-top:10px">
              <button class="btn secondary" id="copyLinBtn">Copy LIN</button>
              <button class="btn blue" id="dlLinBtn">Download .lin</button>
            </div>
          </div>

          <div>
            <div class="small"><b>PBN output</b></div>
            <textarea id="pbnOut" readonly class="mono"></textarea>
            <div class="small" style="margin-top:10px">
              PBN is useful for many solvers/tools. LIN is best for BBO / quick sharing.
            </div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <button class="btn secondary" id="openBsolBtn">Open Bridge Solver Online</button>
          <button class="btn secondary" id="openBboBtn">Open BBO Handviewer</button>
        </div>
      </div>
    </div>
  </div>

  <div style="height:14px"></div>

  <!-- Manual input fallback -->
  <div class="card">
    <div class="in">
      <div class="small"><b>Manual hand input</b> (optional)</div>
      <div class="small">Allowed ranks: <span class="mono">AKQJT98765432</span> (10 or T). No spaces.</div>

      <div style="height:10px"></div>

      <div class="hands">
        <div class="handcard">
          <div class="title">North</div>
          <div class="body">
            <div class="suitRow"><div class="suitIcon s">‚ô†</div><input id="nS" type="text" placeholder="e.g. AKQJ" /></div>
            <div class="suitRow"><div class="suitIcon h">‚ô•</div><input id="nH" type="text" placeholder="e.g. T987" /></div>
            <div class="suitRow"><div class="suitIcon d">‚ô¶</div><input id="nD" type="text" placeholder="e.g. 642" /></div>
            <div class="suitRow"><div class="suitIcon c">‚ô£</div><input id="nC" type="text" placeholder="e.g. A73" /></div>
          </div>
        </div>

        <div class="handcard">
          <div class="title">South</div>
          <div class="body">
            <div class="suitRow"><div class="suitIcon s">‚ô†</div><input id="sS" type="text" /></div>
            <div class="suitRow"><div class="suitIcon h">‚ô•</div><input id="sH" type="text" /></div>
            <div class="suitRow"><div class="suitIcon d">‚ô¶</div><input id="sD" type="text" /></div>
            <div class="suitRow"><div class="suitIcon c">‚ô£</div><input id="sC" type="text" /></div>
          </div>
        </div>

        <div class="handcard">
          <div class="title">East</div>
          <div class="body">
            <div class="suitRow"><div class="suitIcon s">‚ô†</div><input id="eS" type="text" /></div>
            <div class="suitRow"><div class="suitIcon h">‚ô•</div><input id="eH" type="text" /></div>
            <div class="suitRow"><div class="suitIcon d">‚ô¶</div><input id="eD" type="text" /></div>
            <div class="suitRow"><div class="suitIcon c">‚ô£</div><input id="eC" type="text" /></div>
          </div>
        </div>

        <div class="handcard">
          <div class="title">West</div>
          <div class="body">
            <div class="suitRow"><div class="suitIcon s">‚ô†</div><input id="wS" type="text" /></div>
            <div class="suitRow"><div class="suitIcon h">‚ô•</div><input id="wH" type="text" /></div>
            <div class="suitRow"><div class="suitIcon d">‚ô¶</div><input id="wD" type="text" /></div>
            <div class="suitRow"><div class="suitIcon c">‚ô£</div><input id="wC" type="text" /></div>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <button class="btn secondary" id="loadSampleBtn">Load sample</button>
        <button class="btn red" id="clearBtn">Clear</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   Helpers
=========================== */
const $ = (id)=>document.getElementById(id);

const imgPreview = $("imgPreview");
const fileInput  = $("fileInput");
const pasteBtn   = $("pasteBtn");
const imgMsg     = $("imgMsg");
const clickMsg   = $("clickMsg");
const flowMsg    = $("flowMsg");
const sourceSel  = $("sourceSel");

const genBtn     = $("genBtn");
const debugOut   = $("debugOut");
const linOut     = $("linOut");
const pbnOut     = $("pbnOut");
const statusBadge= $("statusBadge");

const copyLinBtn = $("copyLinBtn");
const dlLinBtn   = $("dlLinBtn");
const openBsolBtn= $("openBsolBtn");
const openBboBtn = $("openBboBtn");

const loadSampleBtn = $("loadSampleBtn");
const clearBtn      = $("clearBtn");

const inputs = {
  nS:$("nS"), nH:$("nH"), nD:$("nD"), nC:$("nC"),
  eS:$("eS"), eH:$("eH"), eD:$("eD"), eC:$("eC"),
  sS:$("sS"), sH:$("sH"), sD:$("sD"), sC:$("sC"),
  wS:$("wS"), wH:$("wH"), wD:$("wD"), wC:$("wC"),
};

function normalizeRanks(s){
  if(!s) return "";
  return s.toUpperCase()
    .replace(/\s+/g,"")
    .replace(/10/g,"T")
    .replace(/[^AKQJT98765432]/g,"");
}
function countChars(s){ return (s||"").length; }

function buildPBN(dealer="N", vul="None", hands){
  // PBN "Deal" format: N:spades.hearts.diamonds.clubs (for N, E, S, W)
  // We'll output minimal PBN.
  const fmt = (h)=>`${h.S||""}.${h.H||""}.${h.D||""}.${h.C||""}`;
  return [
    '[Event "MK EasyHand"]',
    '[Site "GitHub Pages"]',
    `[Dealer "${dealer}"]`,
    `[Vulnerable "${vul}"]`,
    `[Deal "N:${fmt(hands.N)} ${fmt(hands.E)} ${fmt(hands.S)} ${fmt(hands.W)}"]`,
  ].join("\n");
}

function buildLIN(board=1, dealer="N", vul="o", hands){
  // Minimal LIN for BBO is not perfectly standardized across all tools,
  // but BBO Handviewer accepts "s=..h=..d=..c=.." blocks (we build those too in URL).
  // We'll output a simple "md|" deal string used by many LIN snippets.
  // Order in md: N, E, S, W with commas.
  const pack = (h)=>`${h.S||""}${h.H||""}${h.D||""}${h.C||""}`;
  // NOTE: we keep commas; external tools interpret.
  return `pn|N,E,S,W|sv|${vul}|bd|${board}|md|3${pack(hands.N)},${pack(hands.E)},${pack(hands.S)},${pack(hands.W)}|`;
}

function setStatus(ok, msg=""){
  statusBadge.className = "status " + (ok ? "ok" : "bad");
  statusBadge.textContent = ok ? "Validation: OK ‚úî" : "Validation: KO ‚úñ";
  if(msg) flowMsg.textContent = msg;
}

function clearOutputs(){
  debugOut.value = "";
  linOut.value = "";
  pbnOut.value = "";
}

function validateAll(h){
  // h: {N:{S,H,D,C}, E..., S..., W...}
  const seatCounts = {
    N: countChars(h.N.S)+countChars(h.N.H)+countChars(h.N.D)+countChars(h.N.C),
    E: countChars(h.E.S)+countChars(h.E.H)+countChars(h.E.D)+countChars(h.E.C),
    S: countChars(h.S.S)+countChars(h.S.H)+countChars(h.S.D)+countChars(h.S.C),
    W: countChars(h.W.S)+countChars(h.W.H)+countChars(h.W.D)+countChars(h.W.C),
  };
  const total = seatCounts.N + seatCounts.E + seatCounts.S + seatCounts.W;

  // duplicates check
  const seen = new Map();
  const dups = [];
  for(const seat of ["N","E","S","W"]){
    for(const suit of ["S","H","D","C"]){
      const str = h[seat][suit] || "";
      for(const ch of str){
        const key = suit + ch;
        const prev = seen.get(key);
        if(prev && prev !== seat){
          dups.push(`${key} in ${prev}+${seat}`);
        }else if(prev && prev === seat){
          // duplicate within same seat (rare unless OCR repeats)
          dups.push(`${key} twice in ${seat}`);
        }else{
          seen.set(key, seat);
        }
      }
    }
  }

  const errs = [];
  for(const seat of ["N","E","S","W"]){
    if(seatCounts[seat] !== 13) errs.push(`Seat ${seat}: ${seatCounts[seat]} cards (expected 13)`);
  }
  if(total !== 52) errs.push(`Total cards: ${total} (expected 52)`);
  if(dups.length) errs.push(`Duplicates: ${dups.slice(0,12).join(", ")}${dups.length>12?" ...":""}`);

  return { ok: errs.length===0, total, seatCounts, errs };
}

/* ===========================
   Image handling (paste/upload)
=========================== */
let currentImage = null; // HTMLImageElement
let canvas = document.createElement("canvas");
let ctx = canvas.getContext("2d", { willReadFrequently: true });

function loadImageFromBlob(blob){
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = () => {
    currentImage = img;
    imgPreview.src = url;
    imgPreview.style.display = "block";
    imgMsg.textContent = "Image loaded ‚úÖ";
    flowMsg.textContent = "Image ready. Click on a suit symbol (FIGB) or use manual input.";
    clickMsg.textContent = "";
    setStatus(false, "Image ready. Click a suit icon, then Generate.");
    clearOutputs();
  };
  img.onerror = () => alert("Cannot load image.");
  img.src = url;
}

pasteBtn.addEventListener("click", async () => {
  try{
    const items = await navigator.clipboard.read();
    for(const it of items){
      const type = it.types.find(t => t.startsWith("image/"));
      if(type){
        const blob = await it.getType(type);
        loadImageFromBlob(blob);
        return;
      }
    }
    alert("No image found in clipboard. Copy a screenshot first.");
  }catch(e){
    alert("Paste failed. Try Ctrl+V on this page or use file upload.\n\n" + e);
  }
});

window.addEventListener("paste", (ev)=>{
  const dt = ev.clipboardData;
  if(!dt) return;
  const file = Array.from(dt.files || []).find(f => f.type.startsWith("image/"));
  if(file){
    loadImageFromBlob(file);
  }
});

fileInput.addEventListener("change", ()=>{
  const f = fileInput.files && fileInput.files[0];
  if(!f) return;
  loadImageFromBlob(f);
});

/* ===========================
   FIGB: symbol-anchored OCR (single player)
   User clicks on any suit icon; we detect that icon blob and read the 4 suit rows for that player.
=========================== */
function drawToCanvas(){
  if(!currentImage) return;
  canvas.width = currentImage.naturalWidth || currentImage.width;
  canvas.height= currentImage.naturalHeight || currentImage.height;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(currentImage, 0, 0);
}

function imgToCanvasXY(clientX, clientY){
  const r = imgPreview.getBoundingClientRect();
  const nx = (clientX - r.left) / r.width;
  const ny = (clientY - r.top)  / r.height;
  const x = Math.max(0, Math.min(canvas.width-1, Math.round(nx * canvas.width)));
  const y = Math.max(0, Math.min(canvas.height-1, Math.round(ny * canvas.height)));
  return {x,y,nx,ny};
}

function rgbAt(x,y){
  const d = ctx.getImageData(x,y,1,1).data;
  return {r:d[0], g:d[1], b:d[2], a:d[3]};
}

// crude color classifiers for FIGB suit icons
function classifySuitColor({r,g,b}){
  // spade: blue-ish
  if(b > 140 && r < 120 && g < 160) return "S";
  // heart: red
  if(r > 160 && g < 110 && b < 120) return "H";
  // diamond: orange
  if(r > 170 && g > 90 && g < 170 && b < 120) return "D";
  // club: green
  if(g > 140 && r < 140 && b < 140) return "C";
  return null;
}

function floodBlobBBox(seedX, seedY, suit, maxPx=9000){
  // BFS flood fill around clicked pixel collecting same suit color class
  const q = [[seedX,seedY]];
  const visited = new Set();
  let minX=seedX, maxX=seedX, minY=seedY, maxY=seedY;
  let count=0;

  const key = (x,y)=> (y<<16) ^ x;
  const inBounds = (x,y)=> x>=0 && y>=0 && x<canvas.width && y<canvas.height;

  while(q.length && count < maxPx){
    const [x,y] = q.pop();
    const k = key(x,y);
    if(visited.has(k)) continue;
    visited.add(k);

    const c = rgbAt(x,y);
    const s = classifySuitColor(c);
    if(s !== suit) continue;

    count++;
    if(x<minX) minX=x; if(x>maxX) maxX=x;
    if(y<minY) minY=y; if(y>maxY) maxY=y;

    // neighbors (4-connect)
    if(inBounds(x+1,y)) q.push([x+1,y]);
    if(inBounds(x-1,y)) q.push([x-1,y]);
    if(inBounds(x,y+1)) q.push([x,y+1]);
    if(inBounds(x,y-1)) q.push([x,y-1]);
  }

  if(count < 60) return null; // too small to be an icon blob
  return {minX, maxX, minY, maxY, count};
}

function cropToDataURL(x,y,w,h){
  const tmp = document.createElement("canvas");
  tmp.width = w; tmp.height = h;
  const tctx = tmp.getContext("2d");
  tctx.drawImage(canvas, x,y,w,h, 0,0,w,h);
  return tmp.toDataURL("image/png");
}

async function ocrROI(dataURL){
  const { data } = await Tesseract.recognize(dataURL, "eng", {
    tessedit_char_whitelist: "AKQJT9876543210",
    preserve_interword_spaces: "0",
  });
  let txt = (data.text || "").toUpperCase();
  txt = txt.replace(/10/g,"T");
  txt = txt.replace(/[^AKQJT98765432]/g,"");
  return txt;
}

let figbAnchor = null; // {x,y,suit,bbox, iconW, iconH}

imgPreview.addEventListener("click", async (ev)=>{
  if(!currentImage){ return; }
  drawToCanvas();

  const {x,y,nx,ny} = imgToCanvasXY(ev.clientX, ev.clientY);
  const c = rgbAt(x,y);
  const suit = classifySuitColor(c);

  clickMsg.textContent = `Clicked at x=${x}, y=${y} | normalized (${nx.toFixed(3)}, ${ny.toFixed(3)})`;

  if(sourceSel.value !== "C"){
    flowMsg.textContent = "Click-detection is currently optimized for FIGB (Source C).";
    return;
  }
  if(!suit){
    flowMsg.textContent = "Please click directly on a suit icon (‚ô†/‚ô•/‚ô¶/‚ô£).";
    return;
  }

  const bbox = floodBlobBBox(x,y,suit);
  if(!bbox){
    flowMsg.textContent = "Could not lock on the suit icon blob. Try clicking closer to the colored icon.";
    return;
  }

  const iconW = bbox.maxX - bbox.minX + 1;
  const iconH = bbox.maxY - bbox.minY + 1;

  figbAnchor = { x, y, suit, bbox, iconW, iconH };

  flowMsg.textContent = `Anchor set: clicked ${suit}. Now press ‚ÄúGenerate‚Äù to OCR this player's 4 suit lines.`;
});

/* ===========================
   Generate (manual or FIGB OCR)
=========================== */
function readManualHands(){
  const h = {
    N:{S:normalizeRanks(inputs.nS.value),H:normalizeRanks(inputs.nH.value),D:normalizeRanks(inputs.nD.value),C:normalizeRanks(inputs.nC.value)},
    E:{S:normalizeRanks(inputs.eS.value),H:normalizeRanks(inputs.eH.value),D:normalizeRanks(inputs.eD.value),C:normalizeRanks(inputs.eC.value)},
    S:{S:normalizeRanks(inputs.sS.value),H:normalizeRanks(inputs.sH.value),D:normalizeRanks(inputs.sD.value),C:normalizeRanks(inputs.sC.value)},
    W:{S:normalizeRanks(inputs.wS.value),H:normalizeRanks(inputs.wH.value),D:normalizeRanks(inputs.wD.value),C:normalizeRanks(inputs.wC.value)},
  };
  return h;
}

async function genFromFIGBAnchor(){
  if(!currentImage || !figbAnchor){
    throw new Error("FIGB mode: paste/upload an image and click a suit icon first.");
  }
  drawToCanvas();

  const b = figbAnchor.bbox;
  const iconW = Math.max(12, figbAnchor.iconW);
  const iconH = Math.max(12, figbAnchor.iconH);

  // Estimate suit-row vertical step: roughly 1.25 * iconH (safe)
  const stepY = Math.round(iconH * 1.35);

  // Use the blob center as row0 reference
  const row0Y = Math.round((b.minY + b.maxY) / 2);

  // Find the four suit rows by scanning around expected y offsets
  // We assume clicked icon belongs to one of the 4 rows; we will search near it for the nearest 4-row stack.
  // Strategy: define a column x around icon center, then sample upward/downward to locate 4 colored icons in a stack.
  const colX = Math.round((b.minX + b.maxX) / 2);

  // We build candidate row centers: y-1*step, y, y+1*step, y+2*step and later sort.
  const candidates = [row0Y - stepY, row0Y, row0Y + stepY, row0Y + 2*stepY];

  // For each candidate, find actual blob by searching in a small window around (colX, yCand)
  function findNearbySuitAt(yCand){
    const r = 14; // search radius
    for(let dy=-r; dy<=r; dy++){
      for(let dx=-r; dx<=r; dx++){
        const xx = colX + dx, yy = yCand + dy;
        if(xx<0||yy<0||xx>=canvas.width||yy>=canvas.height) continue;
        const s = classifySuitColor(rgbAt(xx,yy));
        if(s){
          const bb = floodBlobBBox(xx,yy,s,5000);
          if(bb){
            const cy = Math.round((bb.minY+bb.maxY)/2);
            const cx = Math.round((bb.minX+bb.maxX)/2);
            return {suit:s, bb, cx, cy};
          }
        }
      }
    }
    return null;
  }

  const found = [];
  for(const yCand of candidates){
    const f = findNearbySuitAt(yCand);
    if(f) found.push(f);
  }

  // Deduplicate by suit (we want S/H/D/C once each)
  const bySuit = {};
  for(const f of found){
    if(!bySuit[f.suit]) bySuit[f.suit] = f;
  }

  // If not all 4 suits found, try expanding search (more candidates)
  if(Object.keys(bySuit).length < 4){
    const more = [row0Y - 2*stepY, row0Y + 3*stepY, row0Y - 3*stepY, row0Y + 4*stepY];
    for(const yCand of more){
      const f = findNearbySuitAt(yCand);
      if(f && !bySuit[f.suit]) bySuit[f.suit] = f;
      if(Object.keys(bySuit).length === 4) break;
    }
  }

  const suits = ["S","H","D","C"];
  const missing = suits.filter(s => !bySuit[s]);
  if(missing.length){
    throw new Error("Could not locate all 4 suit icons for this player. Missing: " + missing.join(", ") + ". Try clicking a different suit icon (preferably ‚ô† of that player).");
  }

  // Now crop text ROIs to the right of each suit icon
  // ROI box:
  //   x starts a little right of icon bbox
  //   y spans icon bbox with some padding
  //   width: large enough to capture ranks
  const results = {S:"",H:"",D:"",C:""};
  for(const s of suits){
    const bb = bySuit[s].bb;

    const padY = Math.round(iconH * 0.45);
    const roiX = Math.min(canvas.width-1, bb.maxX + Math.round(iconW * 0.55));
    const roiY = Math.max(0, bb.minY - padY);
    const roiW = Math.max(40, Math.round(iconW * 8.0)); // long enough for "AKQJT987..."
    const roiH = Math.min(canvas.height - roiY, (bb.maxY - bb.minY + 1) + 2*padY);

    const safeW = Math.min(canvas.width - roiX, roiW);
    const safeH = Math.min(canvas.height - roiY, roiH);

    const dataURL = cropToDataURL(roiX, roiY, safeW, safeH);
    const txt = await ocrROI(dataURL);
    results[s] = txt;
  }

  // Place these 13 cards into NORTH by default (single-player OCR test)
  // User can later move to correct seat, or we extend to 4 seats next.
  const h = {
    N:{S:results.S,H:results.H,D:results.D,C:results.C},
    E:{S:"",H:"",D:"",C:""},
    S:{S:"",H:"",D:"",C:""},
    W:{S:"",H:"",D:"",C:""},
  };

  // Mirror into manual UI so user sees it
  inputs.nS.value = h.N.S; inputs.nH.value = h.N.H; inputs.nD.value = h.N.D; inputs.nC.value = h.N.C;

  return h;
}

genBtn.addEventListener("click", async ()=>{
  clearOutputs();

  const source = sourceSel.value;

  try{
    let hands = null;

    if(source === "C" && currentImage && figbAnchor){
      flowMsg.textContent = "Running FIGB OCR (symbol-anchored) ‚Ä¶";
      debugOut.value = "FIGB OCR: starting‚Ä¶\n";
      hands = await genFromFIGBAnchor();
      debugOut.value += "FIGB OCR: done.\n\n";
    }else{
      hands = readManualHands();
      debugOut.value = "Manual input used.\n\n";
    }

    // Validate
    const v = validateAll(hands);
    debugOut.value += "Hands:\n";
    debugOut.value += `N S=${hands.N.S} H=${hands.N.H} D=${hands.N.D} C=${hands.N.C}\n`;
    debugOut.value += `E S=${hands.E.S} H=${hands.E.H} D=${hands.E.D} C=${hands.E.C}\n`;
    debugOut.value += `S S=${hands.S.S} H=${hands.S.H} D=${hands.S.D} C=${hands.S.C}\n`;
    debugOut.value += `W S=${hands.W.S} H=${hands.W.H} D=${hands.W.D} C=${hands.W.C}\n\n`;

    debugOut.value += `Validation: OK=${v.ok} total=${v.total}\n`;
    if(v.errs.length){
      debugOut.value += "Errors:\n - " + v.errs.join("\n - ") + "\n";
      setStatus(false, "Validation KO. Fix duplicates/missing cards or click a cleaner suit icon.");
    }else{
      debugOut.value += "No errors.\n";
      setStatus(true, "Validation OK. You can copy/download LIN or open Solver/BBO.");
    }

    // Build outputs anyway (even if KO, user might want to inspect)
    const lin = buildLIN(1, "N", "o", hands);
    const pbn = buildPBN("N", "None", hands);
    linOut.value = lin;
    pbnOut.value = pbn;

  }catch(e){
    setStatus(false, "Cannot generate. " + (e?.message || e));
    debugOut.value = "ERROR:\n" + (e?.stack || e?.message || e);
  }
});

/* ===========================
   Buttons: copy/download/open
=========================== */
copyLinBtn.addEventListener("click", async ()=>{
  if(!linOut.value) return;
  await navigator.clipboard.writeText(linOut.value);
  flowMsg.textContent = "LIN copied ‚úÖ";
});

dlLinBtn.addEventListener("click", ()=>{
  const txt = linOut.value || "";
  const blob = new Blob([txt], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "hand.lin";
  a.click();
  URL.revokeObjectURL(url);
});

function openBSOL(){
  // Bridge Solver Online supports URL params (varies by deployment).
  // We provide a simple query with PBN deal if possible; otherwise user can paste LIN.
  // We'll open their site and user can paste the LIN/PBN.
  window.open("https://www.bridgebase.com/tools/handviewer.html", "_blank");
}

function openBBOHandviewer(){
  // BBO Handviewer accepts parameters; simplest is open the handviewer page.
  window.open("https://www.bridgebase.com/tools/handviewer.html", "_blank");
}

openBsolBtn.addEventListener("click", openBSOL);
openBboBtn.addEventListener("click", openBBOHandviewer);

/* ===========================
   Sample + Clear
=========================== */
loadSampleBtn.addEventListener("click", ()=>{
  // sample from your earlier board 1
  inputs.nS.value="AJ542"; inputs.nH.value="K6543"; inputs.nD.value="64"; inputs.nC.value="9";
  inputs.eS.value="973";   inputs.eH.value="T987";  inputs.eD.value="8";  inputs.eC.value="AJT53";
  inputs.sS.value="KT6";   inputs.sH.value="AQ";    inputs.sD.value="T2"; inputs.sC.value="KQ7642";
  inputs.wS.value="Q8";    inputs.wH.value="J2";    inputs.wD.value="AKQJ9753"; inputs.wC.value="8";
  flowMsg.textContent="Sample loaded. Click Generate.";
});

clearBtn.addEventListener("click", ()=>{
  for(const k in inputs) inputs[k].value="";
  figbAnchor = null;
  setStatus(false, "Cleared. Paste image and click a suit icon (FIGB), or use manual input.");
  clearOutputs();
});
</script>
</body>
</html>
