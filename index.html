<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MK EasyHand – Bridge → LIN / PBN</title>

<style>
  :root{--bg:#f2f2f2;--card:#fff;--muted:#666;--ok:#0a7a2f;--bad:#b00020;--blue:#1976d2}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:18px}
  h1{margin:0 0 12px 0}
  .box{background:var(--card);border-radius:12px;padding:14px;margin-bottom:14px}
  .small{color:var(--muted);font-size:13px;line-height:1.35}
  .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:#eef3ff;color:#234}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  .seat{border:1px solid #e6e6e6;border-radius:12px;padding:12px}
  .seat h3{margin:0 0 10px 0}
  .row{display:flex;align-items:center;gap:10px;margin:8px 0}
  .suit{width:22px;font-weight:bold}
  input{flex:1;padding:10px;border-radius:10px;border:1px solid #ccc;font-size:14px}
  textarea{width:100%;height:120px;font-family:ui-monospace,Consolas,monospace;font-size:13px;border-radius:10px;border:1px solid #ccc;padding:10px;box-sizing:border-box}
  .actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  button{padding:10px 14px;border:0;border-radius:10px;color:#fff;background:var(--blue);cursor:pointer;font-size:14px}
  button.gray{background:#666}
  button.red{background:var(--bad)}
  button.green{background:var(--ok)}
  button:disabled{opacity:.45;cursor:not-allowed}
  #status{font-weight:bold}
  .ok{color:var(--ok)}
  .bad{color:var(--bad)}
  #debug{white-space:pre-wrap;background:#f7f7f7;border-radius:10px;padding:10px;border:1px solid #eee;font-size:12px;margin-top:10px}
  select{padding:8px 10px;border-radius:10px;border:1px solid #ccc}
</style>
</head>

<body>

<h1>MK EasyHand – Bridge → LIN / PBN</h1>

<div class="box">
  <div class="topbar">
    <span class="pill"><b>1 mano</b> → Validazione → LIN/PBN → Apri BSOL/BBO</span>

    <label for="shotType" class="small"><b>Sorgente screenshot:</b></label>
    <select id="shotType" title="Sorgente screenshot (A RealBridge / B BBO / C Altro)">
      <option value="A">A – RealBridge</option>
      <option value="B">B – BBO</option>
      <option value="C">C – Altro</option>
    </select>

    <span class="small">Usa <b>10</b> oppure <b>T</b>. Il sistema normalizza e controlla doppioni/mancanti.</span>
  </div>

  <div class="small" style="margin-top:8px"><b>Guida:</b> <span id="shotHint"></span></div>

  <div class="actions" style="margin-top:12px">
    <button class="gray" id="btnExample" type="button">Carica esempio</button>
    <button class="red" id="btnClear" type="button">Svuota tutto</button>
    <button class="green" id="btnGen" type="button">Genera LIN / PBN (con validazione)</button>
    <span id="status" class="bad">Validazione KO</span>
  </div>

  <div id="debug">DEBUG: pronto.</div>
</div>

<div class="grid">
  <div class="seat">
    <h3>NORD</h3>
    <div class="row"><div class="suit">♠</div><input id="nS" placeholder="AJ542"></div>
    <div class="row"><div class="suit">♥</div><input id="nH" placeholder="K6543"></div>
    <div class="row"><div class="suit">♦</div><input id="nD" placeholder="64"></div>
    <div class="row"><div class="suit">♣</div><input id="nC" placeholder="9"></div>
  </div>

  <div class="seat">
    <h3>EST</h3>
    <div class="row"><div class="suit">♠</div><input id="eS" placeholder="973"></div>
    <div class="row"><div class="suit">♥</div><input id="eH" placeholder="10987"></div>
    <div class="row"><div class="suit">♦</div><input id="eD" placeholder="8"></div>
    <div class="row"><div class="suit">♣</div><input id="eC" placeholder="AJ1053"></div>
  </div>

  <div class="seat">
    <h3>SUD</h3>
    <div class="row"><div class="suit">♠</div><input id="sS" placeholder="K106"></div>
    <div class="row"><div class="suit">♥</div><input id="sH" placeholder="AQ"></div>
    <div class="row"><div class="suit">♦</div><input id="sD" placeholder="102"></div>
    <div class="row"><div class="suit">♣</div><input id="sC" placeholder="KQ7642"></div>
  </div>

  <div class="seat">
    <h3>OVEST</h3>
    <div class="row"><div class="suit">♠</div><input id="wS" placeholder="Q8"></div>
    <div class="row"><div class="suit">♥</div><input id="wH" placeholder="J2"></div>
    <div class="row"><div class="suit">♦</div><input id="wD" placeholder="AKQJ9753"></div>
    <div class="row"><div class="suit">♣</div><input id="wC" placeholder="8"></div>
  </div>
</div>

<div class="box">
  <b>Output LIN</b>
  <textarea id="outLIN" readonly></textarea>
  <div class="actions">
    <button class="gray" id="btnCopyLin" type="button">Copia LIN</button>
    <button id="btnDlLin" type="button">Scarica .lin</button>
    <button id="btnOpenBSOL" type="button" disabled>Apri in Bridge Solver Online</button>
    <button id="btnOpenBBO" type="button" disabled>Apri in BBO Handviewer</button>
  </div>
  <div class="small">
    Nota: l’apertura è in nuova scheda. Se il browser blocca i popup, consenti “Apri in nuova scheda”.
  </div>
</div>

<div class="box">
  <b>Output PBN</b>
  <textarea id="outPBN" readonly></textarea>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  // --- Hint A/B/C
  function updateShotHint(){
    const v = $("shotType").value;
    const hints = {
      A: "RealBridge: layout di solito più leggibile, simboli chiari e righe ben distanziate.",
      B: "BBO: layout più compatto; attenzione a 10/T e a possibili simboli piccoli.",
      C: "Altro: per ora inserimento manuale (poi aggiungiamo preset/OCR dedicato)."
    };
    $("shotHint").textContent = hints[v] || "";
  }

  // 10 -> T, solo ranks
  function normRanks(t){
    return (t||"")
      .toUpperCase()
      .replace(/10/g,"T")
      .replace(/[^AKQJT98765432]/g,"");
  }

  function readHands(){
    return {
      N:{S:normRanks($("nS").value),H:normRanks($("nH").value),D:normRanks($("nD").value),C:normRanks($("nC").value)},
      E:{S:normRanks($("eS").value),H:normRanks($("eH").value),D:normRanks($("eD").value),C:normRanks($("eC").value)},
      S:{S:normRanks($("sS").value),H:normRanks($("sH").value),D:normRanks($("sD").value),C:normRanks($("sC").value)},
      W:{S:normRanks($("wS").value),H:normRanks($("wH").value),D:normRanks($("wD").value),C:normRanks($("wC").value)}
    };
  }

  function validate52(h){
    const seen = new Set();
    const errors = [];
    const seats = ["N","E","S","W"];
    const suits = ["S","H","D","C"];
    let tot = 0;

    for (const p of seats){
      let cnt = 0;
      for (const s of suits){
        for (const r of h[p][s]){
          tot++; cnt++;
          const k = s + r;
          if (seen.has(k)) errors.push("Doppione: " + k);
          seen.add(k);
        }
      }
      if (cnt !== 13) errors.push(`Seat ${p}: ${cnt} carte (attese 13)`);
    }
    if (tot !== 52) errors.push(`Totale carte: ${tot} (attese 52)`);

    return { ok: errors.length===0, tot, errors };
  }

  function setStatus(ok){
    $("status").className = ok ? "ok" : "bad";
    $("status").textContent = ok ? "Validazione OK ✅" : "Validazione KO";
    $("btnOpenBSOL").disabled = !ok;
    $("btnOpenBBO").disabled = !ok;
  }

  // MVP: board/dealer/vul fissi (poi li leggeremo da screenshot)
  const BOARD_NO = 1;
  const DEALER = "N";
  const VUL_NONE = "None";

  // BSOL seat string S.H.D.C
  function seatDots(seat){ return `${seat.S||"-"}.${seat.H||"-"}.${seat.D||"-"}.${seat.C||"-"}`; }
  // Handviewer seat string s..h..d..c.. (lowercase)
  function seatHV(seat){ return (`s${seat.S}h${seat.H}d${seat.D}c${seat.C}`).toLowerCase(); }

  function buildOutputs(h){
    const n = seatDots(h.N);
    const e = seatDots(h.E);
    const s = seatDots(h.S);
    const w = seatDots(h.W);

    $("outPBN").value =
`[Board "${BOARD_NO}"]
[Dealer "${DEALER}"]
[Vulnerable "${VUL_NONE}"]
[Deal "N:${n} ${e} ${s} ${w}"]`;

    // LIN minimal deal (ordine N,W,E,S come già ti funziona)
    const md = `${h.N.S}${h.N.H}${h.N.D}${h.N.C},${h.W.S}${h.W.H}${h.W.D}${h.W.C},${h.E.S}${h.E.H}${h.E.D}${h.E.C},${h.S.S}${h.S.H}${h.S.D}${h.S.C}`;
    $("outLIN").value = `pn|N,E,S,W|sv|o|bd|${BOARD_NO}|md|3${md}|`;
  }

  function buildBSOLUrl(h){
    const base = "https://dds.bridgewebs.com/bsol2/ddummy.htm";
    const params = new URLSearchParams({
      board: String(BOARD_NO),
      dealer: DEALER,
      vul: VUL_NONE,
      north: seatDots(h.N),
      east:  seatDots(h.E),
      south: seatDots(h.S),
      west:  seatDots(h.W),
      analyse: "true"
    });
    return `${base}?${params.toString()}`;
  }

  function buildBBOUrl(h){
    const base = "https://www.bridgebase.com/tools/handviewer.html";
    const params = new URLSearchParams({
      b: String(BOARD_NO),
      d: DEALER.toLowerCase(),
      v: "-", // none
      n: seatHV(h.N),
      e: seatHV(h.E),
      s: seatHV(h.S),
      w: seatHV(h.W)
    });
    return `${base}?${params.toString()}`;
  }

  function debugDump(h, vld){
    $("debug").textContent =
`DEBUG LETTURA:
N ♠=${h.N.S} ♥=${h.N.H} ♦=${h.N.D} ♣=${h.N.C}
E ♠=${h.E.S} ♥=${h.E.H} ♦=${h.E.D} ♣=${h.E.C}
S ♠=${h.S.S} ♥=${h.S.H} ♦=${h.S.D} ♣=${h.S.C}
W ♠=${h.W.S} ♥=${h.W.H} ♦=${h.W.D} ♣=${h.W.C}

Validazione:
OK=${vld.ok}  tot=${vld.tot}
${vld.errors.length ? ("Errori:\n- " + vld.errors.join("\n- ")) : "Nessun errore."}

Sorgente selezionata: ${$("shotType").value}`;
  }

  // UI actions
  $("btnExample").onclick = () => {
    $("nS").value="AJ542"; $("nH").value="K6543"; $("nD").value="64"; $("nC").value="9";
    $("eS").value="973";   $("eH").value="10987"; $("eD").value="8";  $("eC").value="AJ1053";
    $("sS").value="K106";  $("sH").value="AQ";    $("sD").value="102";$("sC").value="KQ7642";
    $("wS").value="Q8";    $("wH").value="J2";    $("wD").value="AKQJ9753"; $("wC").value="8";
  };

  $("btnClear").onclick = () => {
    for (const id of ["nS","nH","nD","nC","eS","eH","eD","eC","sS","sH","sD","sC","wS","wH","wD","wC"]) $(id).value="";
    $("outLIN").value=""; $("outPBN").value="";
    $("debug").textContent="DEBUG: svuotato.";
    setStatus(false);
  };

  $("btnGen").onclick = () => {
    document.activeElement && document.activeElement.blur();
    setTimeout(() => {
      const h = readHands();
      const vld = validate52(h);
      debugDump(h, vld);
      setStatus(vld.ok);

      if (!vld.ok){
        $("outLIN").value = "";
        $("outPBN").value = "";
        return;
      }
      buildOutputs(h);
    }, 0);
  };

  $("btnCopyLin").onclick = async () => {
    const t = $("outLIN").value || "";
    if (!t.trim()) return;
    await navigator.clipboard.writeText(t);
  };

  $("btnDlLin").onclick = () => {
    const t = $("outLIN").value || "";
    if (!t.trim()) return;
    const blob = new Blob([t + "\n"], {type:"text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `board${BOARD_NO}.lin`;
    a.click();
  };

  $("btnOpenBSOL").onclick = () => {
    const h = readHands();
    const vld = validate52(h);
    if (!vld.ok) return;
    window.open(buildBSOLUrl(h), "_blank", "noopener,noreferrer");
  };

  $("btnOpenBBO").onclick = () => {
    const h = readHands();
    const vld = validate52(h);
    if (!vld.ok) return;
    window.open(buildBBOUrl(h), "_blank", "noopener,noreferrer");
  };

  // init
  $("shotType").addEventListener("change", updateShotHint);
  updateShotHint();
  setStatus(false);
</script>

</body>
</html>
