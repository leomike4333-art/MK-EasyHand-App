<script>
  const RANKS = "AKQJT98765432";
  const HCP = {A:4, K:3, Q:2, J:1};

  // prende l'input "giusto": se ci sono ID duplicati, usa quello visibile
  function pickVisibleById(id){
    const list = document.querySelectorAll(`#${CSS.escape(id)}`);
    if(!list || list.length === 0) return { el:null, count:0 };

    // preferisci elemento visibile (offsetParent != null) e con dimensioni > 0
    for(let i=list.length-1; i>=0; i--){
      const el = list[i];
      const visible = (el.offsetParent !== null) && (el.getBoundingClientRect().width > 0);
      if(visible) return { el, count:list.length };
    }
    // fallback: ultimo
    return { el:list[list.length-1], count:list.length };
  }

  function normRanks(x){
    return (x || "")
      .toUpperCase()
      .replace(/10/g,"T")
      .replace(/[^AKQJT98765432]/g,"");
  }

  function getVal(id){
    const p = pickVisibleById(id);
    return {
      v: p.el ? normRanks(p.el.value) : "",
      count: p.count
    };
  }

  function readHands(){
    const nS = getVal("nS"), nH = getVal("nH"), nD = getVal("nD"), nC = getVal("nC");
    const eS = getVal("eS"), eH = getVal("eH"), eD = getVal("eD"), eC = getVal("eC");
    const sS = getVal("sS"), sH = getVal("sH"), sD = getVal("sD"), sC = getVal("sC");
    const wS = getVal("wS"), wH = getVal("wH"), wD = getVal("wD"), wC = getVal("wC");

    return {
      hands: {
        N: { S:nS.v, H:nH.v, D:nD.v, C:nC.v },
        E: { S:eS.v, H:eH.v, D:eD.v, C:eC.v },
        S: { S:sS.v, H:sH.v, D:sD.v, C:sC.v },
        W: { S:wS.v, H:wH.v, D:wD.v, C:wC.v }
      },
      counts: {
        nS:nS.count, nH:nH.count, nD:nD.count, nC:nC.count,
        eS:eS.count, eH:eH.count, eD:eD.count, eC:eC.count,
        sS:sS.count, sH:sH.count, sD:sD.count, sC:sC.count,
        wS:wS.count, wH:wH.count, wD:wD.count, wC:wC.count
      }
    };
  }

  function validateDeal(hands){
    const seen = new Set();
    const problems = [];
    let total = 0;

    function add(seat, suit, ranks){
      for(const r of ranks){
        total++;
        const key = suit + r;
        if(seen.has(key)) problems.push(`Doppione: ${key} (seat ${seat})`);
        seen.add(key);
      }
    }

    const perSeat = {};
    for(const seat of ["N","E","S","W"]){
      const h = hands[seat];
      add(seat, "S", h.S);
      add(seat, "H", h.H);
      add(seat, "D", h.D);
      add(seat, "C", h.C);
      perSeat[seat] = h.S.length + h.H.length + h.D.length + h.C.length;
      if(perSeat[seat] !== 13) problems.push(`Seat ${seat}: ${perSeat[seat]} carte (attese 13)`);
    }

    const missing = [];
    for(const suit of ["S","H","D","C"]){
      for(const r of RANKS){
        const key = suit + r;
        if(!seen.has(key)) missing.push(key);
      }
    }

    const ok = (problems.length === 0 && total === 52 && missing.length === 0);
    return { ok, total, problems, missing, perSeat };
  }

  function seatPBN(sp, he, di, cl){
    const S = sp || "-";
    const H = he || "-";
    const D = di || "-";
    const C = cl || "-";
    return `${S}.${H}.${D}.${C}`;
  }

  function seatRAW(sp, he, di, cl){
    return `${sp}${he}${di}${cl}`;
  }

  function buildPBN(board, dealer, vul, N, E, S, W){
    const vulPbn = (vul==="o")?"None":(vul==="n")?"NS":(vul==="e")?"EW":"All";
    return `[Event "MK EasyHand"]\n[Board "${board}"]\n[Dealer "${dealer}"]\n[Vulnerable "${vulPbn}"]\n[Deal "N:${N} ${E} ${S} ${W}"]\n`;
  }

  function buildLIN(board, dealer, vul, Nraw, Wraw, Eraw, Sraw){
    const dealerIdx = ({S:"1",W:"2",N:"3",E:"4"})[dealer] || "3";
    return `pn|N,E,S,W|sv|${vul}|bd|${board}|md|${dealerIdx}${Nraw},${Wraw},${Eraw},${Sraw}|`;
  }

  const genBtn = document.getElementById("genBtn");
  const genMsg = document.getElementById("genMsg");
  const debug = document.getElementById("debug");
  const outLIN = document.getElementById("outLIN");
  const outPBN = document.getElementById("outPBN");

  genBtn.addEventListener("click", (e) => {
    e.preventDefault();   // evita submit/reset
    e.stopPropagation();

    const { hands, counts } = readHands();

    // DEBUG: mostra valori + quanti duplicati ID ci sono
    debug.textContent =
      `DEBUG LETTURA:\n` +
      `N ♠=${hands.N.S} ♥=${hands.N.H} ♦=${hands.N.D} ♣=${hands.N.C}\n` +
      `E ♠=${hands.E.S} ♥=${hands.E.H} ♦=${hands.E.D} ♣=${hands.E.C}\n` +
      `S ♠=${hands.S.S} ♥=${hands.S.H} ♦=${hands.S.D} ♣=${hands.S.C}\n` +
      `W ♠=${hands.W.S} ♥=${hands.W.H} ♦=${hands.W.D} ♣=${hands.W.C}\n\n` +
      `ID duplicati (se >1 è il problema):\n` +
      `nS=${counts.nS} nH=${counts.nH} nD=${counts.nD} nC=${counts.nC}\n` +
      `eS=${counts.eS} eH=${counts.eH} eD=${counts.eD} eC=${counts.eC}\n` +
      `sS=${counts.sS} sH=${counts.sH} sD=${counts.sD} sC=${counts.sC}\n` +
      `wS=${counts.wS} wH=${counts.wH} wD=${counts.wD} wC=${counts.wC}\n`;

    const val = validateDeal(hands);
    if(!val.ok){
      genMsg.innerHTML = `<span class="bad">Validazione KO (tot=${val.total})</span>`;
      outLIN.value = "";
      outPBN.value = "";
      return;
    }

    genMsg.innerHTML = `<span class="ok">Validazione OK ✅</span>`;

    const board="1", dealer="N", vul="o";
    const Npbn = seatPBN(hands.N.S, hands.N.H, hands.N.D, hands.N.C);
    const Epbn = seatPBN(hands.E.S, hands.E.H, hands.E.D, hands.E.C);
    const Spbn = seatPBN(hands.S.S, hands.S.H, hands.S.D, hands.S.C);
    const Wpbn = seatPBN(hands.W.S, hands.W.H, hands.W.D, hands.W.C);

    const Nraw = seatRAW(hands.N.S, hands.N.H, hands.N.D, hands.N.C);
    const Eraw = seatRAW(hands.E.S, hands.E.H, hands.E.D, hands.E.C);
    const Sraw = seatRAW(hands.S.S, hands.S.H, hands.S.D, hands.S.C);
    const Wraw = seatRAW(hands.W.S, hands.W.H, hands.W.D, hands.W.C);

    outPBN.value = buildPBN(board, dealer, vul, Npbn, Epbn, Spbn, Wpbn);
    outLIN.value = buildLIN(board, dealer, vul, Nraw, Wraw, Eraw, Sraw);
  });
</script>
