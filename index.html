<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MK EasyHand â€“ Paste â†’ Seat â†’ LIN/PBN (v1C)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body{
    font-family: Arial, Helvetica, sans-serif;
    background:#f4f4f4;
    margin:0;
    padding:14px;
  }
  h1{margin:0 0 6px;font-size:22px}
  .small{font-size:13px;color:#666}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
  .panel{
    background:#fff;
    border-radius:10px;
    padding:12px;
    margin-bottom:12px;
  }
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  button{
    padding:8px 12px;
    font-size:14px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    background:#1976d2;
    color:white;
  }
  button.gray{background:#666}
  button.red{background:#b00020}
  button.green{background:#1b7f2a}
  button:disabled{opacity:0.55;cursor:not-allowed}
  input,select{
    padding:6px;
    font-size:14px;
  }
  #imgPreview{
    max-width:100%;
    border:1px solid #ccc;
    margin-top:8px;
    display:none;
    touch-action: manipulation;
  }
  .ok{color:green;font-weight:bold}
  .err{color:#b00020;font-weight:bold}

  /* manual inputs layout */
  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media(max-width:820px){
    .grid{grid-template-columns:1fr}
  }
  .seatBox{
    border:1px solid #ddd;
    border-radius:10px;
    padding:10px;
    background:#fafafa;
  }
  .seatBox h3{
    margin:0 0 8px;
    font-size:16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .badge{
    font-size:12px;
    padding:3px 8px;
    border-radius:999px;
    background:#eee;
    color:#333;
  }
  .seatBox.active{
    border:2px solid #1976d2;
    background:#eef5ff;
  }
  .suitRow{
    display:grid;
    grid-template-columns: 22px 1fr;
    gap:8px;
    align-items:center;
    margin:6px 0;
  }

  /* suit focus bar */
  .suitBar{
    display:none;
    margin-top:10px;
    padding:10px;
    border:1px solid #e0e0e0;
    border-radius:10px;
    background:#fbfbfb;
  }
  .suitBtn{
    background:#333;
    border:0;
    border-radius:8px;
    padding:8px 10px;
    font-size:16px;
    color:#fff;
  }
  .suitBtn:focus{outline:2px solid #1976d2}
  .outBox textarea{
    width:100%;
    min-height:84px;
    border-radius:10px;
    border:1px solid #ddd;
    padding:10px;
    font-size:13px;
  }
</style>
</head>

<body>

<h1>MK EasyHand â€“ Bridge â†’ LIN / PBN</h1>
<div class="small">
  Screenshot â†’ <b>Paste</b> â†’ <b>Click image</b> (seat N/E/S/W) â†’ tap â™ â™¥â™¦â™£ to type â†’ <b>Generate LIN/PBN</b> â†’ Open Bridge Solver / BBO.
</div>

<!-- TOP BAR: source + paste/upload + board params -->
<div class="panel">
  <div class="row">
    <label><b>Source:</b></label>
    <select id="source">
      <option value="A">A â€“ RealBridge</option>
      <option value="B">B â€“ BBO</option>
      <option value="C">C â€“ Federation / Local</option>
      <option value="D">D â€“ LoveBridge (WBF)</option>
      <option value="E">E â€“ Bulletin (ACBL / EBL / WBF)</option>
    </select>

    <button id="pasteBtn">ðŸ“‹ Paste</button>
    <input type="file" id="fileInput" accept="image/*" />

    <span class="small" style="margin-left:6px"><b>Board:</b></span>
    <input id="boardNo" value="1" style="width:56px" />

    <span class="small"><b>Dealer:</b></span>
    <select id="dealer">
      <option value="N">N</option><option value="E">E</option><option value="S">S</option><option value="W">W</option>
    </select>

    <span class="small"><b>Vul:</b></span>
    <select id="vul">
      <option value="None">None</option>
      <option value="NS">NS</option>
      <option value="EW">EW</option>
      <option value="All">All</option>
    </select>

    <button class="gray" id="loadSampleBtn">Load sample</button>
    <button class="red" id="clearBtn">Clear</button>
  </div>

  <div id="pasteMsg" class="small"></div>

  <img id="imgPreview" alt="Screenshot preview" />
  <div id="clickMsg" class="small"></div>
  <div id="seatMsg" class="small"></div>

  <div class="suitBar" id="suitBar">
    <div class="row">
      <div class="small"><b>Seat selected:</b> <span id="seatNow" class="ok">?</span> â€” tap a suit to jump to the right field:</div>
      <button class="suitBtn" id="btnSp">â™ </button>
      <button class="suitBtn" id="btnHe">â™¥</button>
      <button class="suitBtn" id="btnDi">â™¦</button>
      <button class="suitBtn" id="btnCl">â™£</button>
      <div class="small">(Use <b>10</b> or <b>T</b>)</div>
    </div>
  </div>
</div>

<!-- MANUAL INPUTS -->
<div class="panel" id="manualPanel">
  <b>Manual hand input</b>
  <div class="small">Allowed ranks: AKQJT98765432 (10 or T). No spaces.</div>

  <div class="grid" style="margin-top:10px">
    <div class="seatBox" id="boxN">
      <h3>North <span class="badge">N</span></h3>
      <div class="suitRow"><div>â™ </div><input class="mono" id="nS" placeholder="e.g. AKQJ" /></div>
      <div class="suitRow"><div>â™¥</div><input class="mono" id="nH" placeholder="e.g. T987" /></div>
      <div class="suitRow"><div>â™¦</div><input class="mono" id="nD" placeholder="e.g. 642" /></div>
      <div class="suitRow"><div>â™£</div><input class="mono" id="nC" placeholder="e.g. A73" /></div>
    </div>

    <div class="seatBox" id="boxE">
      <h3>East <span class="badge">E</span></h3>
      <div class="suitRow"><div>â™ </div><input class="mono" id="eS" /></div>
      <div class="suitRow"><div>â™¥</div><input class="mono" id="eH" /></div>
      <div class="suitRow"><div>â™¦</div><input class="mono" id="eD" /></div>
      <div class="suitRow"><div>â™£</div><input class="mono" id="eC" /></div>
    </div>

    <div class="seatBox" id="boxS">
      <h3>South <span class="badge">S</span></h3>
      <div class="suitRow"><div>â™ </div><input class="mono" id="sS" /></div>
      <div class="suitRow"><div>â™¥</div><input class="mono" id="sH" /></div>
      <div class="suitRow"><div>â™¦</div><input class="mono" id="sD" /></div>
      <div class="suitRow"><div>â™£</div><input class="mono" id="sC" /></div>
    </div>

    <div class="seatBox" id="boxW">
      <h3>West <span class="badge">W</span></h3>
      <div class="suitRow"><div>â™ </div><input class="mono" id="wS" /></div>
      <div class="suitRow"><div>â™¥</div><input class="mono" id="wH" /></div>
      <div class="suitRow"><div>â™¦</div><input class="mono" id="wD" /></div>
      <div class="suitRow"><div>â™£</div><input class="mono" id="wC" /></div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <button class="green" id="genBtn">Generate LIN / PBN (validate)</button>
    <div id="valMsg" class="small"></div>
  </div>
</div>

<!-- OUTPUT -->
<div class="panel outBox">
  <b>LIN output</b>
  <div class="row" style="margin-top:8px">
    <button class="gray" id="copyLinBtn">Copy LIN</button>
    <button class="gray" id="dlLinBtn">Download .lin</button>
    <button class="gray" id="openBsolBtn">Open Bridge Solver Online</button>
    <button class="gray" id="openBboBtn">Open BBO Handviewer</button>
  </div>
  <textarea id="linOut" class="mono" placeholder="(will appear here)"></textarea>

  <div style="height:10px"></div>
  <b>PBN output</b>
  <textarea id="pbnOut" class="mono" placeholder="(will appear here)"></textarea>
</div>

<script>
  // ---------- DOM ----------
  const imgPreview = document.getElementById("imgPreview");
  const pasteBtn   = document.getElementById("pasteBtn");
  const fileInput  = document.getElementById("fileInput");
  const pasteMsg   = document.getElementById("pasteMsg");
  const clickMsg   = document.getElementById("clickMsg");
  const seatMsg    = document.getElementById("seatMsg");
  const seatNow    = document.getElementById("seatNow");
  const suitBar    = document.getElementById("suitBar");

  const boardNo    = document.getElementById("boardNo");
  const dealerSel  = document.getElementById("dealer");
  const vulSel     = document.getElementById("vul");
  const loadSampleBtn = document.getElementById("loadSampleBtn");
  const clearBtn   = document.getElementById("clearBtn");

  const genBtn     = document.getElementById("genBtn");
  const valMsg     = document.getElementById("valMsg");
  const linOut     = document.getElementById("linOut");
  const pbnOut     = document.getElementById("pbnOut");

  const copyLinBtn = document.getElementById("copyLinBtn");
  const dlLinBtn   = document.getElementById("dlLinBtn");
  const openBsolBtn= document.getElementById("openBsolBtn");
  const openBboBtn = document.getElementById("openBboBtn");

  const seatBoxes = {
    N: document.getElementById("boxN"),
    E: document.getElementById("boxE"),
    S: document.getElementById("boxS"),
    W: document.getElementById("boxW"),
  };

  const inputs = {
    N: {S: document.getElementById("nS"), H: document.getElementById("nH"), D: document.getElementById("nD"), C: document.getElementById("nC")},
    E: {S: document.getElementById("eS"), H: document.getElementById("eH"), D: document.getElementById("eD"), C: document.getElementById("eC")},
    S: {S: document.getElementById("sS"), H: document.getElementById("sH"), D: document.getElementById("sD"), C: document.getElementById("sC")},
    W: {S: document.getElementById("wS"), H: document.getElementById("wH"), D: document.getElementById("wD"), C: document.getElementById("wC")},
  };

  // suit focus buttons
  const btnSp = document.getElementById("btnSp");
  const btnHe = document.getElementById("btnHe");
  const btnDi = document.getElementById("btnDi");
  const btnCl = document.getElementById("btnCl");

  let activeSeat = null;

  // ---------- HELPERS ----------
  function clearSeatHighlight(){
    Object.values(seatBoxes).forEach(b => b.classList.remove("active"));
  }
  function setActiveSeat(seat){
    activeSeat = seat;
    clearSeatHighlight();
    seatBoxes[seat].classList.add("active");
    seatNow.textContent = seat;
    suitBar.style.display = "block";
    // auto-focus spades for that seat
    setTimeout(() => inputs[seat].S.focus(), 150);
  }

  function showImage(blob, origin){
    const url = URL.createObjectURL(blob);
    imgPreview.src = url;
    imgPreview.style.display = "block";
    pasteMsg.textContent = origin;
    clickMsg.textContent = "";
    seatMsg.innerHTML = "Click the screenshot near a hand to select the seat (N/E/S/W).";
    suitBar.style.display = "none";
    activeSeat = null;
    clearSeatHighlight();
  }

  // ---------- PASTE ----------
  pasteBtn.onclick = async () => {
    pasteMsg.textContent = "";
    if(!navigator.clipboard || !navigator.clipboard.read){
      pasteMsg.textContent = "Clipboard paste not supported here.";
      return;
    }
    try{
      const items = await navigator.clipboard.read();
      for(const it of items){
        const t = it.types.find(x => x.startsWith("image/"));
        if(t){
          const blob = await it.getType(t);
          showImage(blob, "Image pasted from clipboard.");
          return;
        }
      }
      pasteMsg.textContent = "No image found in clipboard.";
    }catch(err){
      pasteMsg.textContent = "Clipboard access denied (HTTPS required).";
    }
  };

  // ---------- UPLOAD ----------
  fileInput.onchange = () => {
    const f = fileInput.files[0];
    if(!f) return;
    showImage(f, "Image loaded from file.");
  };

  // ---------- STEP 1B: seat detection ----------
  function detectSeat(nx, ny){
    // Universal rule-of-thumb (works great for BBO/RB/FIGB/LoveBridge layouts)
    const TOP = 0.28, BOT = 0.72, LEFT = 0.28, RIGHT = 0.72;
    if(ny < TOP) return "N";
    if(ny > BOT) return "S";
    if(nx < LEFT) return "W";
    if(nx > RIGHT) return "E";
    return null; // center area (board/auction)
  }

  function handleClick(e){
    if(imgPreview.style.display === "none") return;

    const rect = imgPreview.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;

    const x = Math.round(cx - rect.left);
    const y = Math.round(cy - rect.top);

    const nx = x / rect.width;
    const ny = y / rect.height;

    clickMsg.innerHTML =
      `Clicked at x=${x}, y=${y} &nbsp; | &nbsp; normalized (${nx.toFixed(3)}, ${ny.toFixed(3)})`;

    const seat = detectSeat(nx, ny);
    if(!seat){
      seatMsg.innerHTML = `<span class="err">Center area detected (board/auction zone). Click closer to a hand.</span>`;
      suitBar.style.display = "none";
      activeSeat = null;
      clearSeatHighlight();
      return;
    }

    seatMsg.innerHTML = `<span class="ok">Seat detected: ${seat}</span>`;
    setActiveSeat(seat);
    // scroll to manual (nice on mobile)
    document.getElementById("manualPanel").scrollIntoView({behavior:"smooth", block:"start"});
  }

  imgPreview.addEventListener("click", handleClick);
  imgPreview.addEventListener("touchstart", handleClick, {passive:true});

  // ---------- STEP 1C: suit focus after seat selected ----------
  function focusSuit(suit){
    if(!activeSeat) return;
    inputs[activeSeat][suit].focus();
  }
  btnSp.onclick = () => focusSuit("S");
  btnHe.onclick = () => focusSuit("H");
  btnDi.onclick = () => focusSuit("D");
  btnCl.onclick = () => focusSuit("C");

  // ---------- NORMALIZE + VALIDATE ----------
  const RANKS = "AKQJT98765432";
  function normalizeCards(txt){
    if(!txt) return "";
    let t = (""+txt).toUpperCase();
    t = t.replaceAll("10","T");
    t = t.replaceAll(" ", "").replaceAll("-", "");
    // remove common suit symbols if pasted accidentally
    t = t.replaceAll("â™ ","").replaceAll("â™¥","").replaceAll("â™¦","").replaceAll("â™£","");
    // keep only ranks
    let out = "";
    for(const ch of t){
      if(RANKS.includes(ch)) out += ch;
    }
    return out;
  }

  function buildAllCards(){
    const seats = ["N","E","S","W"];
    const suits = ["S","H","D","C"];
    const seen = new Set();
    const seatCounts = {N:0,E:0,S:0,W:0};
    const errors = [];

    const norm = {};
    for(const seat of seats){
      norm[seat] = {};
      for(const su of suits){
        const v = normalizeCards(inputs[seat][su].value);
        inputs[seat][su].value = v; // write back normalized
        norm[seat][su] = v;

        for(const r of v){
          const id = su + r; // e.g. SA
          if(seen.has(id)) errors.push(`Duplicate card: ${id}`);
          seen.add(id);
          seatCounts[seat] += 1;
        }
      }
      if(seatCounts[seat] !== 13){
        errors.push(`Seat ${seat}: ${seatCounts[seat]} cards (expected 13)`);
      }
    }
    if(seen.size !== 52){
      errors.push(`Total cards: ${seen.size} (expected 52)`);
    }
    return {norm, seenSize: seen.size, seatCounts, errors};
  }

  // ---------- OUTPUT: LIN / PBN ----------
  function vulToBbo(v){
    // for handviewer url and general text
    return v; // None/NS/EW/All
  }

  function pbnVul(v){
    if(v === "None") return "None";
    if(v === "NS") return "NS";
    if(v === "EW") return "EW";
    if(v === "All") return "All";
    return "None";
  }

  function toPBNDeal(norm){
    // PBN deal format: "N:spades.hearts.diamonds.clubs ..."
    // in PBN, suits are separated by '.' ; empty suit is empty
    function seatStr(seat){
      return `${norm[seat].S}.${norm[seat].H}.${norm[seat].D}.${norm[seat].C}`;
    }
    return `N:${seatStr("N")} ${seatStr("E")} ${seatStr("S")} ${seatStr("W")}`;
  }

  function toLIN(norm){
    // Keep same compact LIN style we used earlier.
    // md|<dealerIndex><N>,<E>,<S>,<W>|
    // dealerIndex: 1=S,2=W,3=N,4=E (commonly used). We map from dealer letter.
    const map = {S:"1", W:"2", N:"3", E:"4"};
    const di = map[dealerSel.value] || "3";
    const N = `${norm.N.S}${norm.N.H}${norm.N.D}${norm.N.C}`;
    const E = `${norm.E.S}${norm.E.H}${norm.E.D}${norm.E.C}`;
    const S = `${norm.S.S}${norm.S.H}${norm.S.D}${norm.S.C}`;
    const W = `${norm.W.S}${norm.W.H}${norm.W.D}${norm.W.C}`;

    const bd = parseInt(boardNo.value || "1", 10) || 1;
    return `pn|N,E,S,W|sv|o|bd|${bd}|md|${di}${N},${E},${S},${W}|`;
  }

  function buildPBN(norm){
    const bd = parseInt(boardNo.value || "1", 10) || 1;
    const dl = dealerSel.value;
    const vu = pbnVul(vulSel.value);
    const deal = toPBNDeal(norm);
    return [
      `% PBN 2.1`,
      `[Event "MK EasyHand"]`,
      `[Board "${bd}"]`,
      `[Dealer "${dl}"]`,
      `[Vulnerable "${vu}"]`,
      `[Deal "${deal}"]`
    ].join("\n");
  }

  // ---------- ACTIONS ----------
  genBtn.onclick = () => {
    const {norm, errors, seenSize} = buildAllCards();
    if(errors.length){
      valMsg.innerHTML = `<span class="err">Validation KO</span> â€” ${errors[0]}`;
      linOut.value = "";
      pbnOut.value = "";
      return;
    }
    valMsg.innerHTML = `<span class="ok">Validation OK</span> (52 cards)`;
    linOut.value = toLIN(norm);
    pbnOut.value = buildPBN(norm);
  };

  copyLinBtn.onclick = async () => {
    if(!linOut.value.trim()) return;
    try{
      await navigator.clipboard.writeText(linOut.value);
      valMsg.innerHTML = `<span class="ok">LIN copied</span>`;
    }catch{
      valMsg.innerHTML = `<span class="err">Copy failed</span>`;
    }
  };

  dlLinBtn.onclick = () => {
    const txt = linOut.value.trim();
    if(!txt) return;
    const blob = new Blob([txt], {type:"text/plain"});
    const a = document.createElement("a");
    const bd = parseInt(boardNo.value || "1", 10) || 1;
    a.download = `board${bd}.lin`;
    a.href = URL.createObjectURL(blob);
    a.click();
  };

  openBsolBtn.onclick = () => {
    // Bridge Solver Online accepts url with params (varies). We'll use a very common format:
    // https://bridge-solver.com/ ?deal=... is not universal, so we do a safe approach:
    // open a new tab with a hint; user can paste PBN if needed.
    if(!pbnOut.value.trim()){
      valMsg.innerHTML = `<span class="err">Generate PBN first</span>`;
      return;
    }
    // As fallback: open Bridge Solver home; user can paste the PBN in Input Hand
    window.open("https://bridge-solver.com/", "_blank");
    valMsg.innerHTML = `<span class="ok">Bridge Solver opened</span> â€” paste the PBN in â€œInput Handâ€.`;
  };

  openBboBtn.onclick = () => {
    // BBO handviewer URL supports: https://www.bridgebase.com/tools/handviewer.html?lin=...
    const txt = linOut.value.trim();
    if(!txt){
      valMsg.innerHTML = `<span class="err">Generate LIN first</span>`;
      return;
    }
    const url = "https://www.bridgebase.com/tools/handviewer.html?lin=" + encodeURIComponent(txt);
    window.open(url, "_blank");
  };

  // sample load
  loadSampleBtn.onclick = () => {
    boardNo.value = "1";
    dealerSel.value = "N";
    vulSel.value = "None";
    inputs.N.S.value="AJ542"; inputs.N.H.value="K6543"; inputs.N.D.value="64"; inputs.N.C.value="9";
    inputs.E.S.value="973"; inputs.E.H.value="10987"; inputs.E.D.value="8"; inputs.E.C.value="AJ1053";
    inputs.S.S.value="K106"; inputs.S.H.value="AQ"; inputs.S.D.value="102"; inputs.S.C.value="KQ7642";
    inputs.W.S.value="Q8"; inputs.W.H.value="J2"; inputs.W.D.value="AKQJ9753"; inputs.W.C.value="8";
    valMsg.innerHTML = `<span class="small">Sample loaded</span>`;
    linOut.value=""; pbnOut.value="";
  };

  clearBtn.onclick = () => {
    for(const seat of ["N","E","S","W"]){
      for(const su of ["S","H","D","C"]){
        inputs[seat][su].value="";
      }
    }
    linOut.value=""; pbnOut.value="";
    valMsg.textContent="";
    suitBar.style.display="none";
    activeSeat=null;
    clearSeatHighlight();
    seatMsg.textContent="";
    clickMsg.textContent="";
  };
</script>

</body>
</html>
