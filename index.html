<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MK-EasyHand-App</title>
<style>
  :root{--bg:#f4f4f4;--card:#fff;--muted:#666;--ok:#0a7a2f;--bad:#b00020;--blue:#1976d2}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:14px}
  h1{font-size:20px;margin:0 0 6px}
  .muted{color:var(--muted);font-size:13px;line-height:1.35}
  .box{background:var(--card);border-radius:12px;padding:12px;margin:12px 0}
  .sources{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .srcRow{display:flex;flex-wrap:wrap;align-items:center;gap:10px;border:1px solid #e8e8e8;border-radius:12px;padding:10px}
  .srcTag{font-weight:bold;min-width:22px}
  .srcName{flex:1}
  button{padding:10px 12px;border:0;border-radius:10px;background:var(--blue);color:#fff;cursor:pointer;font-size:14px}
  button.gray{background:#666}
  button:disabled{opacity:.45;cursor:not-allowed}
  #imgPreview{max-width:100%;border:1px solid #ddd;border-radius:10px;margin-top:10px;display:none}
  .statusLine{margin-top:8px}
  .ok{color:var(--ok);font-weight:bold}
  .bad{color:var(--bad);font-weight:bold}
  input[type="file"]{font-size:14px}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef3ff;color:#234;font-size:12px}
</style>
</head>

<body>
<h1>MK-EasyHand-App</h1>
<div class="muted">
  Screenshot ‚Üí Estrai mano ‚Üí Apri Bridge Solver / BBO.<br>
  Suggerimento: fai lo screenshot e poi usa <b>Incolla</b> (immagine negli appunti).
</div>

<div class="box">
  <div class="muted"><span class="pill">Metodo veloce</span> Seleziona la sorgente e premi <b>Incolla</b>.</div>

  <div class="sources">
    <div class="srcRow">
      <div class="srcTag">A</div>
      <div class="srcName">RealBridge</div>
      <button type="button" class="pasteBtn" data-source="A">üìã Incolla</button>
    </div>

    <div class="srcRow">
      <div class="srcTag">B</div>
      <div class="srcName">BBO</div>
      <button type="button" class="pasteBtn" data-source="B">üìã Incolla</button>
    </div>

    <div class="srcRow">
      <div class="srcTag">C</div>
      <div class="srcName">Federation / Local software (es. MY FIGB)</div>
      <button type="button" class="pasteBtn" data-source="C">üìã Incolla</button>
    </div>

    <div class="srcRow">
      <div class="srcTag">D</div>
      <div class="srcName">LoveBridge (WBF)</div>
      <button type="button" class="pasteBtn" data-source="D">üìã Incolla</button>
    </div>

    <div class="srcRow">
      <div class="srcTag">E</div>
      <div class="srcName">Bulletin diagram (ACBL / EBL / WBF)</div>
      <button type="button" class="pasteBtn" data-source="E">üìã Incolla</button>
    </div>
  </div>

  <div class="statusLine muted" style="margin-top:12px">
    <b>Oppure</b> carica il file manualmente:
    <input type="file" id="fileInput" accept="image/*" />
    <button type="button" id="useFileBtn" class="gray">Usa questo file</button>
  </div>

  <div id="pasteStatus" class="muted statusLine"></div>

  <img id="imgPreview" alt="Preview screenshot" />
</div>

<div class="box">
  <div><b>Stato</b></div>
  <div id="state" class="muted">In attesa di immagine‚Ä¶</div>
  <div id="chosen" class="muted" style="margin-top:6px"></div>
</div>

<script>
  const pasteStatus = document.getElementById("pasteStatus");
  const imgPreview = document.getElementById("imgPreview");
  const state = document.getElementById("state");
  const chosen = document.getElementById("chosen");
  const fileInput = document.getElementById("fileInput");
  const useFileBtn = document.getElementById("useFileBtn");
  const pasteBtns = document.querySelectorAll(".pasteBtn");

  let currentSource = null;   // "A".."E"
  let currentBlob = null;     // screenshot blob

  function showStatusOK(msg){
    pasteStatus.innerHTML = `<span class="ok">‚úÖ ${msg}</span>`;
  }
  function showStatusBad(msg){
    pasteStatus.innerHTML = `<span class="bad">‚ùå ${msg}</span>`;
  }

  function setCurrent(source){
    currentSource = source;
    chosen.textContent = source ? `Sorgente selezionata: ${source}` : "";
  }

  function handleImageBlob(blob, how){
    if(!blob){
      showStatusBad("Nessuna immagine.");
      return;
    }
    currentBlob = blob;
    const url = URL.createObjectURL(blob);
    imgPreview.src = url;
    imgPreview.style.display = "block";
    state.innerHTML = `Immagine caricata. <b>Pronta</b> per estrazione mano (fase successiva).`;
    showStatusOK(`Immagine acquisita (${how}).`);
  }

  async function pasteFromClipboard(){
    if (!navigator.clipboard || !navigator.clipboard.read) {
      showStatusBad("Funzione Incolla non supportata qui. Usa ‚ÄòCarica file‚Äô. (Serve HTTPS e browser moderno)");
      return null;
    }
    const items = await navigator.clipboard.read();
    for (const item of items) {
      const imgType = item.types.find(t => t.startsWith("image/"));
      if (imgType) {
        return await item.getType(imgType);
      }
    }
    return null;
  }

  pasteBtns.forEach(btn => {
    btn.addEventListener("click", async () => {
      const src = btn.getAttribute("data-source");
      setCurrent(src);
      pasteStatus.textContent = "Leggo dagli appunti‚Ä¶";
      try{
        const blob = await pasteFromClipboard();
        if(!blob){
          showStatusBad("Negli appunti non c‚Äô√® un‚Äôimmagine. Fai prima uno screenshot e riprova.");
          return;
        }
        handleImageBlob(blob, `Incolla (${src})`);
      }catch(err){
        console.error(err);
        showStatusBad("Impossibile leggere gli appunti (permessi/HTTPS). Usa ‚ÄòCarica file‚Äô.");
      }
    });
  });

  // Fallback: file picker
  useFileBtn.addEventListener("click", () => {
    const f = fileInput.files && fileInput.files[0];
    if(!f){
      showStatusBad("Seleziona prima un file immagine.");
      return;
    }
    // se l'utente non ha scelto una source, mettiamo C (Other) come default ragionevole
    if(!currentSource) setCurrent("C");
    handleImageBlob(f, "Carica file");
  });

  // init
  setCurrent(null);
</script>

</body>
</html>
