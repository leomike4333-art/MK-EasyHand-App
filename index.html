<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MK EasyHand App</title>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
      --ok:#16a34a; --bad:#dc2626; --blue:#2563eb; --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:28px}
    .sub{margin-top:6px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .in{padding:14px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--muted);font-size:12px}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:#111827;color:#fff}
    .btn.secondary{background:#374151}
    .btn.blue{background:var(--blue)}
    .btn.green{background:var(--ok)}
    .btn.red{background:var(--bad)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    select,input[type="text"]{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff}
    input[type="file"]{padding:8px;border-radius:12px;border:1px solid var(--border);background:#fff}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .small{font-size:12px;color:var(--muted)}
    .status{font-weight:800;display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#fff}
    .status.ok{color:var(--ok)}
    .status.bad{color:var(--bad)}
    .imgBox{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff}
    #imgPreview{display:none;max-width:100%;height:auto;cursor:crosshair}
    .clickline{margin-top:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    textarea{width:100%;min-height:130px;border:1px solid var(--border);border-radius:14px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .hands{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.hands{grid-template-columns:1fr}}
    .handcard{border:1px solid var(--border);border-radius:16px;background:#fff}
    .handcard .title{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:900}
    .handcard .body{padding:12px}
    .suitRow{display:grid;grid-template-columns:24px 1fr;gap:10px;align-items:center;margin:8px 0}
    .suitIcon{font-size:18px}
    .s{color:#2563eb} .h{color:#dc2626} .d{color:#f59e0b} .c{color:#16a34a}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.twoCols{grid-template-columns:1fr}}
    .hint{margin-top:10px;padding:10px;border:1px dashed var(--border);border-radius:14px;background:#fff;color:var(--muted)}
    .kbd{font-family:ui-monospace;background:#f3f4f6;border:1px solid #e5e7eb;padding:2px 6px;border-radius:8px;color:#111827}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>MK EasyHand App</h1>
    <div class="sub">Screenshot â†’ Paste / Upload â†’ <b>Click a suit icon</b> â†’ Generate LIN â†’ Open Solver / BBO</div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="in">
      <div class="row">
        <label><b>Source:</b></label>
        <select id="sourceSel">
          <option value="A">A â€“ RealBridge</option>
          <option value="B">B â€“ BBO</option>
          <option value="C" selected>C â€“ Federation / Local (FIGB)</option>
          <option value="D">D â€“ LoveBridge / WBF</option>
        </select>

        <button class="btn blue" id="pasteBtn">ðŸ“‹ Paste</button>
        <input type="file" id="fileInput" accept="image/*">

        <span id="imgMsg" class="pill">No image yet.</span>

        <span class="status bad" id="statusBadge">Validation: KO âœ–</span>

        <button class="btn green" id="genBtn">Generate LIN/PBN (validate)</button>
      </div>

      <div class="hint">
        <b>FIGB mode (Source C):</b> paste/upload â†’ click directly on <b>ONE</b> suit icon (â™ /â™¥/â™¦/â™£).<br/>
        This version does <b>NOT</b> search the other 3 icons: it uses vertical offsets anchored to the clicked icon (more robust).<br/>
        Tip: use <span class="kbd">Ctrl+F5</span> or add <span class="kbd">?v=123</span> to bypass cache.
      </div>
    </div>
  </div>

  <div style="height:14px"></div>

  <div class="grid">
    <div class="card">
      <div class="in">
        <div class="imgBox">
          <img id="imgPreview" alt="preview">
        </div>
        <div class="clickline small mono" id="clickMsg"></div>
        <div class="small" style="margin-top:8px">
          <b>Status:</b> <span id="flowMsg">Paste or upload an image.</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="in">
        <div class="small"><b>Debug</b> (last run)</div>
        <textarea id="debugOut" readonly class="mono" style="min-height:160px"></textarea>

        <div style="height:10px"></div>

        <div class="twoCols">
          <div>
            <div class="small"><b>LIN output</b></div>
            <textarea id="linOut" readonly class="mono"></textarea>
            <div class="row" style="margin-top:10px">
              <button class="btn secondary" id="copyLinBtn">Copy LIN</button>
              <button class="btn blue" id="dlLinBtn">Download .lin</button>
            </div>
          </div>

          <div>
            <div class="small"><b>PBN output</b></div>
            <textarea id="pbnOut" readonly class="mono"></textarea>
            <div class="small" style="margin-top:10px">
              PBN is useful for many solvers/tools. LIN is best for BBO / quick sharing.
            </div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <button class="btn secondary" id="openBsolBtn">Open Bridge Solver Online</button>
          <button class="btn secondary" id="openBboBtn">Open BBO Handviewer</button>
        </div>
      </div>
    </div>
  </div>

  <div style="height:14px"></div>

  <div class="card">
    <div class="in">
      <div class="small"><b>Manual hand input</b> (optional)</div>
      <div class="small">Allowed ranks: <span class="mono">AKQJT98765432</span> (10 or T). No spaces.</div>

      <div style="height:10px"></div>

      <div class="hands">
        <div class="handcard">
          <div class="title">North</div>
          <div class="body">
            <div class="suitRow"><div class="suitIcon s">â™ </div><input id="nS" type="text" placeholder="e.g. AKQJ" /></div>
            <div class="suitRow"><div class="suitIcon h">â™¥</div><input id="nH" type="text" placeholder="e.g. T987" /></div>
            <div class="suitRow"><div class="suitIcon d">â™¦</div><input id="nD" type="text" placeholder="e.g. 642" /></div>
            <div class="suitRow"><div class="suitIcon c">â™£</div><input id="nC" type="text" placeholder="e.g. A73" /></div>
          </div>
        </div>

        <div class="handcard">
          <div class="title">South</div>
          <div class="body">
            <div class="suitRow"><div class="suitIcon s">â™ </div><input id="sS" type="text" /></div>
            <div class="suitRow"><div class="suitIcon h">â™¥</div><input id="sH" type="text" /></div>
            <div class="suitRow"><div class="suitIcon d">â™¦</div><input id="sD" type="text" /></div>
            <div class="suitRow"><div class="suitIcon c">â™£</div><input id="sC" type="text" /></div>
          </div>
        </div>

        <div class="handcard">
          <div class="title">East</div>
          <div class="body">
            <div class="suitRow"><div class="suitIcon s">â™ </div><input id="eS" type="text" /></div>
            <div class="suitRow"><div class="suitIcon h">â™¥</div><input id="eH" type="text" /></div>
            <div class="suitRow"><div class="suitIcon d">â™¦</div><input id="eD" type="text" /></div>
            <div class="suitRow"><div class="suitIcon c">â™£</div><input id="eC" type="text" /></div>
          </div>
        </div>

        <div class="handcard">
          <div class="title">West</div>
          <div class="body">
            <div class="suitRow"><div class="suitIcon s">â™ </div><input id="wS" type="text" /></div>
            <div class="suitRow"><div class="suitIcon h">â™¥</div><input id="wH" type="text" /></div>
            <div class="suitRow"><div class="suitIcon d">â™¦</div><input id="wD" type="text" /></div>
            <div class="suitRow"><div class="suitIcon c">â™£</div><input id="wC" type="text" /></div>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <button class="btn secondary" id="loadSampleBtn">Load sample</button>
        <button class="btn red" id="clearBtn">Clear</button>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);

const imgPreview = $("imgPreview");
const fileInput  = $("fileInput");
const pasteBtn   = $("pasteBtn");
const imgMsg     = $("imgMsg");
const clickMsg   = $("clickMsg");
const flowMsg    = $("flowMsg");
const sourceSel  = $("sourceSel");

const genBtn     = $("genBtn");
const debugOut   = $("debugOut");
const linOut     = $("linOut");
const pbnOut     = $("pbnOut");
const statusBadge= $("statusBadge");

const copyLinBtn = $("copyLinBtn");
const dlLinBtn   = $("dlLinBtn");
const openBsolBtn= $("openBsolBtn");
const openBboBtn = $("openBboBtn");

const loadSampleBtn = $("loadSampleBtn");
const clearBtn      = $("clearBtn");

const inputs = {
  nS:$("nS"), nH:$("nH"), nD:$("nD"), nC:$("nC"),
  eS:$("eS"), eH:$("eH"), eD:$("eD"), eC:$("eC"),
  sS:$("sS"), sH:$("sH"), sD:$("sD"), sC:$("sC"),
  wS:$("wS"), wH:$("wH"), wD:$("wD"), wC:$("wC"),
};

function normalizeRanks(s){
  if(!s) return "";
  return s.toUpperCase()
    .replace(/\s+/g,"")
    .replace(/10/g,"T")
    .replace(/[^AKQJT98765432]/g,"");
}
function countChars(s){ return (s||"").length; }

function buildPBN(dealer="N", vul="None", hands){
  const fmt = (h)=>`${h.S||""}.${h.H||""}.${h.D||""}.${h.C||""}`;
  return [
    '[Event "MK EasyHand"]',
    '[Site "GitHub Pages"]',
    `[Dealer "${dealer}"]`,
    `[Vulnerable "${vul}"]`,
    `[Deal "N:${fmt(hands.N)} ${fmt(hands.E)} ${fmt(hands.S)} ${fmt(hands.W)}"]`,
  ].join("\n");
}

function buildLIN(board=1, dealer="N", vul="o", hands){
  const pack = (h)=>`${h.S||""}${h.H||""}${h.D||""}${h.C||""}`;
  return `pn|N,E,S,W|sv|${vul}|bd|${board}|md|3${pack(hands.N)},${pack(hands.E)},${pack(hands.S)},${pack(hands.W)}|`;
}

function setStatus(ok, msg=""){
  statusBadge.className = "status " + (ok ? "ok" : "bad");
  statusBadge.textContent = ok ? "Validation: OK âœ”" : "Validation: KO âœ–";
  if(msg) flowMsg.textContent = msg;
}

function clearOutputs(){
  debugOut.value = "";
  linOut.value = "";
  pbnOut.value = "";
}

function validateAll(h){
  const seatCounts = {
    N: countChars(h.N.S)+countChars(h.N.H)+countChars(h.N.D)+countChars(h.N.C),
    E: countChars(h.E.S)+countChars(h.E.H)+countChars(h.E.D)+countChars(h.E.C),
    S: countChars(h.S.S)+countChars(h.S.H)+countChars(h.S.D)+countChars(h.S.C),
    W: countChars(h.W.S)+countChars(h.W.H)+countChars(h.W.D)+countChars(h.W.C),
  };
  const total = seatCounts.N + seatCounts.E + seatCounts.S + seatCounts.W;

  const seen = new Map();
  const dups = [];
  for(const seat of ["N","E","S","W"]){
    for(const suit of ["S","H","D","C"]){
      const str = h[seat][suit] || "";
      for(const ch of str){
        const key = suit + ch;
        const prev = seen.get(key);
        if(prev && prev !== seat) dups.push(`${key} in ${prev}+${seat}`);
        else if(prev && prev === seat) dups.push(`${key} twice in ${seat}`);
        else seen.set(key, seat);
      }
    }
  }

  const errs = [];
  for(const seat of ["N","E","S","W"]){
    if(seatCounts[seat] !== 13) errs.push(`Seat ${seat}: ${seatCounts[seat]} cards (expected 13)`);
  }
  if(total !== 52) errs.push(`Total cards: ${total} (expected 52)`);
  if(dups.length) errs.push(`Duplicates: ${dups.slice(0,12).join(", ")}${dups.length>12?" ...":""}`);

  return { ok: errs.length===0, total, seatCounts, errs };
}

/* ===== Image handling ===== */
let currentImage = null;
let canvas = document.createElement("canvas");
let ctx = canvas.getContext("2d", { willReadFrequently: true });

function loadImageFromBlob(blob){
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = () => {
    currentImage = img;
    imgPreview.src = url;
    imgPreview.style.display = "block";
    imgMsg.textContent = "Image loaded âœ…";
    flowMsg.textContent = "Image ready. Click on a suit icon (FIGB) or use manual input.";
    clickMsg.textContent = "";
    setStatus(false, "Image ready. Click a suit icon, then Generate.");
    clearOutputs();
  };
  img.onerror = () => alert("Cannot load image.");
  img.src = url;
}

pasteBtn.addEventListener("click", async () => {
  try{
    const items = await navigator.clipboard.read();
    for(const it of items){
      const type = it.types.find(t => t.startsWith("image/"));
      if(type){
        const blob = await it.getType(type);
        loadImageFromBlob(blob);
        return;
      }
    }
    alert("No image found in clipboard. Copy a screenshot first.");
  }catch(e){
    alert("Paste failed. Try Ctrl+V on this page or use file upload.\n\n" + e);
  }
});

window.addEventListener("paste", (ev)=>{
  const dt = ev.clipboardData;
  if(!dt) return;
  const file = Array.from(dt.files || []).find(f => f.type.startsWith("image/"));
  if(file) loadImageFromBlob(file);
});

fileInput.addEventListener("change", ()=>{
  const f = fileInput.files && fileInput.files[0];
  if(!f) return;
  loadImageFromBlob(f);
});

function drawToCanvas(){
  if(!currentImage) return;
  canvas.width = currentImage.naturalWidth || currentImage.width;
  canvas.height= currentImage.naturalHeight || currentImage.height;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(currentImage, 0, 0);
}

function imgToCanvasXY(clientX, clientY){
  const r = imgPreview.getBoundingClientRect();
  const nx = (clientX - r.left) / r.width;
  const ny = (clientY - r.top)  / r.height;
  const x = Math.max(0, Math.min(canvas.width-1, Math.round(nx * canvas.width)));
  const y = Math.max(0, Math.min(canvas.height-1, Math.round(ny * canvas.height)));
  return {x,y,nx,ny};
}

function rgbAt(x,y){
  const d = ctx.getImageData(x,y,1,1).data;
  return {r:d[0], g:d[1], b:d[2], a:d[3]};
}

function classifySuitColor({r,g,b}){
  if(b > 140 && r < 120 && g < 170) return "S";          // spade blue
  if(r > 160 && g < 120 && b < 130) return "H";          // heart red
  if(r > 170 && g > 90 && g < 175 && b < 140) return "D"; // diamond orange
  if(g > 140 && r < 150 && b < 150) return "C";          // club green
  return null;
}

function floodBlobBBox(seedX, seedY, suit, maxPx=12000){
  const q = [[seedX,seedY]];
  const visited = new Set();
  let minX=seedX, maxX=seedX, minY=seedY, maxY=seedY;
  let count=0;

  const key = (x,y)=> (y<<16) ^ x;
  const inBounds = (x,y)=> x>=0 && y>=0 && x<canvas.width && y<canvas.height;

  while(q.length && count < maxPx){
    const [x,y] = q.pop();
    const k = key(x,y);
    if(visited.has(k)) continue;
    visited.add(k);

    const s = classifySuitColor(rgbAt(x,y));
    if(s !== suit) continue;

    count++;
    if(x<minX) minX=x; if(x>maxX) maxX=x;
    if(y<minY) minY=y; if(y>maxY) maxY=y;

    if(inBounds(x+1,y)) q.push([x+1,y]);
    if(inBounds(x-1,y)) q.push([x-1,y]);
    if(inBounds(x,y+1)) q.push([x,y+1]);
    if(inBounds(x,y-1)) q.push([x,y-1]);
  }

  if(count < 60) return null;
  return {minX, maxX, minY, maxY, count};
}

function cropToDataURL(x,y,w,h){
  const tmp = document.createElement("canvas");
  tmp.width = w; tmp.height = h;
  const tctx = tmp.getContext("2d");
  tctx.drawImage(canvas, x,y,w,h, 0,0,w,h);
  return tmp.toDataURL("image/png");
}

async function ocrROI(dataURL){
  const { data } = await Tesseract.recognize(dataURL, "eng", {
    tessedit_char_whitelist: "AKQJT9876543210",
    preserve_interword_spaces: "0",
  });
  let txt = (data.text || "").toUpperCase();
  txt = txt.replace(/10/g,"T");
  txt = txt.replace(/[^AKQJT98765432]/g,"");
  return txt;
}

/* ===== FIGB Anchor state ===== */
let figbAnchor = null; // {suit, bbox, centerX, centerY, iconW, iconH}

function suitIndex(s){ return ({S:0,H:1,D:2,C:3})[s]; }

imgPreview.addEventListener("click", (ev)=>{
  if(!currentImage) return;
  drawToCanvas();

  const {x,y,nx,ny} = imgToCanvasXY(ev.clientX, ev.clientY);
  const suit = classifySuitColor(rgbAt(x,y));

  clickMsg.textContent = `Clicked at x=${x}, y=${y} | normalized (${nx.toFixed(3)}, ${ny.toFixed(3)})`;

  if(sourceSel.value !== "C"){
    flowMsg.textContent = "Click-detection is optimized for FIGB (Source C).";
    return;
  }
  if(!suit){
    flowMsg.textContent = "Please click directly on a colored suit icon (â™ /â™¥/â™¦/â™£).";
    return;
  }

  const bbox = floodBlobBBox(x,y,suit);
  if(!bbox){
    flowMsg.textContent = "Could not lock onto the icon blob. Try clicking more inside the colored icon.";
    return;
  }

  const iconW = bbox.maxX - bbox.minX + 1;
  const iconH = bbox.maxY - bbox.minY + 1;
  const centerX = Math.round((bbox.minX + bbox.maxX)/2);
  const centerY = Math.round((bbox.minY + bbox.maxY)/2);

  figbAnchor = { suit, bbox, centerX, centerY, iconW, iconH };
  flowMsg.textContent = `Anchor set on ${suit}. Now press Generate to OCR the 4 suit lines for this player (no icon search).`;
});

/* ===== Generate ===== */
function readManualHands(){
  return {
    N:{S:normalizeRanks(inputs.nS.value),H:normalizeRanks(inputs.nH.value),D:normalizeRanks(inputs.nD.value),C:normalizeRanks(inputs.nC.value)},
    E:{S:normalizeRanks(inputs.eS.value),H:normalizeRanks(inputs.eH.value),D:normalizeRanks(inputs.eD.value),C:normalizeRanks(inputs.eC.value)},
    S:{S:normalizeRanks(inputs.sS.value),H:normalizeRanks(inputs.sH.value),D:normalizeRanks(inputs.sD.value),C:normalizeRanks(inputs.sC.value)},
    W:{S:normalizeRanks(inputs.wS.value),H:normalizeRanks(inputs.wH.value),D:normalizeRanks(inputs.wD.value),C:normalizeRanks(inputs.wC.value)},
  };
}

async function genFromFIGBAnchor(){
  if(!currentImage || !figbAnchor) throw new Error("FIGB: paste/upload then click a suit icon first.");
  drawToCanvas();

  const { suit, bbox, iconW, iconH, centerX, centerY } = figbAnchor;

  // Estimate line spacing: icons are fairly tall; step ~ 1.40 * iconH works well on FIGB screenshots
  const stepY = Math.max(22, Math.round(iconH * 1.40));

  // Use the clicked icon as reference for X (where text begins)
  const padX = Math.round(iconW * 0.65);
  const textX = Math.min(canvas.width-1, bbox.maxX + padX);

  // ROI size
  const roiW = Math.min(canvas.width - textX, Math.max(180, Math.round(iconW * 9.0))); // wide text strip
  const roiH = Math.min(canvas.height, Math.max(26, Math.round(iconH * 1.55)));        // line height

  // Determine y center for each suit line by relative offsets from clicked suit
  const idxClicked = suitIndex(suit); // 0..3
  const suits = ["S","H","D","C"];
  const out = {S:"",H:"",D:"",C:""};

  // For each target suit line i, its centerY = clickedCenterY + (i-idxClicked)*stepY
  // Crop at y = centerY - roiH/2
  for(let i=0;i<4;i++){
    const sy = suits[i];
    const cy = centerY + (i - idxClicked) * stepY;

    const x = textX;
    const y = Math.max(0, Math.min(canvas.height-1, Math.round(cy - roiH/2)));
    const h = Math.min(canvas.height - y, roiH);

    const dataURL = cropToDataURL(x, y, roiW, h);
    const txt = await ocrROI(dataURL);
    out[sy] = txt;
  }

  // Put into North for now (single-player OCR test)
  const hands = {
    N:{S:out.S,H:out.H,D:out.D,C:out.C},
    E:{S:"",H:"",D:"",C:""},
    S:{S:"",H:"",D:"",C:""},
    W:{S:"",H:"",D:"",C:""},
  };

  // Show in UI
  inputs.nS.value = hands.N.S; inputs.nH.value = hands.N.H; inputs.nD.value = hands.N.D; inputs.nC.value = hands.N.C;

  return hands;
}

genBtn.addEventListener("click", async ()=>{
  clearOutputs();

  try{
    let hands = null;

    if(sourceSel.value === "C" && currentImage && figbAnchor){
      flowMsg.textContent = "Running FIGB OCR (anchor offsets) â€¦";
      debugOut.value = "FIGB OCR: startingâ€¦\n";
      hands = await genFromFIGBAnchor();
      debugOut.value += "FIGB OCR: done.\n\n";
    }else{
      hands = readManualHands();
      debugOut.value = "Manual input used.\n\n";
    }

    // normalize fields
    for(const seat of ["N","E","S","W"]){
      for(const su of ["S","H","D","C"]){
        hands[seat][su] = normalizeRanks(hands[seat][su]);
      }
    }

    const v = validateAll(hands);

    debugOut.value += "Hands:\n";
    debugOut.value += `N S=${hands.N.S} H=${hands.N.H} D=${hands.N.D} C=${hands.N.C}\n`;
    debugOut.value += `E S=${hands.E.S} H=${hands.E.H} D=${hands.E.D} C=${hands.E.C}\n`;
    debugOut.value += `S S=${hands.S.S} H=${hands.S.H} D=${hands.S.D} C=${hands.S.C}\n`;
    debugOut.value += `W S=${hands.W.S} H=${hands.W.H} D=${hands.W.D} C=${hands.W.C}\n\n`;

    debugOut.value += `Validation: OK=${v.ok} total=${v.total}\n`;
    if(v.errs.length){
      debugOut.value += "Errors:\n - " + v.errs.join("\n - ") + "\n";
      setStatus(false, "Validation KO. OCR may have missed/added ranks. Try clicking â™  of that player (best).");
    }else{
      debugOut.value += "No errors.\n";
      setStatus(true, "Validation OK. Copy/download LIN or open Solver/BBO.");
    }

    linOut.value = buildLIN(1, "N", "o", hands);
    pbnOut.value = buildPBN("N", "None", hands);

  }catch(e){
    setStatus(false, "Cannot generate. " + (e?.message || e));
    debugOut.value = "ERROR:\n" + (e?.stack || e?.message || e);
  }
});

/* ===== Buttons ===== */
copyLinBtn.addEventListener("click", async ()=>{
  if(!linOut.value) return;
  await navigator.clipboard.writeText(linOut.value);
  flowMsg.textContent = "LIN copied âœ…";
});

dlLinBtn.addEventListener("click", ()=>{
  const txt = linOut.value || "";
  const blob = new Blob([txt], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "hand.lin";
  a.click();
  URL.revokeObjectURL(url);
});

openBsolBtn.addEventListener("click", ()=>window.open("https://www.bridgebase.com/tools/handviewer.html","_blank"));
openBboBtn.addEventListener("click", ()=>window.open("https://www.bridgebase.com/tools/handviewer.html","_blank"));

/* ===== Sample / Clear ===== */
loadSampleBtn.addEventListener("click", ()=>{
  inputs.nS.value="AJ542"; inputs.nH.value="K6543"; inputs.nD.value="64"; inputs.nC.value="9";
  inputs.eS.value="973";   inputs.eH.value="T987";  inputs.eD.value="8";  inputs.eC.value="AJT53";
  inputs.sS.value="KT6";   inputs.sH.value="AQ";    inputs.sD.value="T2"; inputs.sC.value="KQ7642";
  inputs.wS.value="Q8";    inputs.wH.value="J2";    inputs.wD.value="AKQJ9753"; inputs.wC.value="8";
  flowMsg.textContent="Sample loaded. Click Generate.";
});

clearBtn.addEventListener("click", ()=>{
  for(const k in inputs) inputs[k].value="";
  figbAnchor = null;
  setStatus(false, "Cleared. Paste image and click a suit icon (FIGB), or use manual input.");
  clearOutputs();
});
</script>
</body>
</html>
