  <!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MK EasyHand – Manual → LIN/PBN</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:20px; }
    h1 { margin:0 0 12px 0; font-size:22px; }
    .box { background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; }
    .seat { font-weight:bold; margin-bottom:6px; }
    .line { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .suit { width:18px; }
    input { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
    button { padding:10px 14px; font-size:16px; border:none; border-radius:10px; background:#1976d2; color:white; cursor:pointer; }
    button:active { background:#0f4fa8; }
    textarea { width:100%; height:140px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size:13px; }
    .ok { color:#0a7a2f; font-weight:bold; }
    .bad { color:#b00020; font-weight:bold; }
    .muted { color:#666; }
    .debug { margin-top:10px; font-size:12px; color:#222; white-space:pre-wrap; background:#f7f7f7; border:1px solid #eee; padding:10px; border-radius:10px; }
  </style>
</head>

<body>

<h1>MK EasyHand – Manual → LIN/PBN</h1>

<div class="box">
  <b>Inserisci mano (manuale)</b>
  <span class="muted">(1 riga per seme, usa <b>10</b> oppure <b>T</b>)</span>
</div>

<div class="box">
  <div class="seat">NORD</div>
  <div class="line"><span class="suit">♠</span><input id="nS" placeholder="AJ542"></div>
  <div class="line"><span class="suit">♥</span><input id="nH" placeholder="K6543"></div>
  <div class="line"><span class="suit">♦</span><input id="nD" placeholder="64"></div>
  <div class="line"><span class="suit">♣</span><input id="nC" placeholder="9"></div>
</div>

<div class="box">
  <div class="seat">EST</div>
  <div class="line"><span class="suit">♠</span><input id="eS" placeholder="973"></div>
  <div class="line"><span class="suit">♥</span><input id="eH" placeholder="10987"></div>
  <div class="line"><span class="suit">♦</span><input id="eD" placeholder="8"></div>
  <div class="line"><span class="suit">♣</span><input id="eC" placeholder="AJ1053"></div>
</div>

<div class="box">
  <div class="seat">SUD</div>
  <div class="line"><span class="suit">♠</span><input id="sS" placeholder="K106"></div>
  <div class="line"><span class="suit">♥</span><input id="sH" placeholder="AQ"></div>
  <div class="line"><span class="suit">♦</span><input id="sD" placeholder="102"></div>
  <div class="line"><span class="suit">♣</span><input id="sC" placeholder="KQ7642"></div>
</div>

<div class="box">
  <div class="seat">OVEST</div>
  <div class="line"><span class="suit">♠</span><input id="wS" placeholder="Q8"></div>
  <div class="line"><span class="suit">♥</span><input id="wH" placeholder="J2"></div>
  <div class="line"><span class="suit">♦</span><input id="wD" placeholder="AKQJ9753"></div>
  <div class="line"><span class="suit">♣</span><input id="wC" placeholder="8"></div>

  <div style="margin-top:12px;">
    <button id="genBtn" type="button">Genera LIN / PBN (con validazione)</button>
    <span id="genMsg" style="margin-left:10px;"></span>
    <div id="debug" class="debug">DEBUG: pronto.</div>
  </div>
</div>

<div class="box">
  <b>Output LIN</b>
  <textarea id="outLIN" readonly></textarea>
</div>

<div class="box">
  <b>Output PBN</b>
  <textarea id="outPBN" readonly></textarea>
</div>

<script>
  const RANKS = "AKQJT98765432";

  const $ = (id) => document.getElementById(id);

  // Se per qualsiasi motivo ci fossero ID duplicati, usa quello visibile
  function pickVisibleById(id){
    let list;
    try {
      list = document.querySelectorAll(`#${CSS.escape(id)}`);
    } catch(e){
      // fallback rarissimo
      list = document.querySelectorAll(`[id="${id}"]`);
    }
    if(!list || list.length === 0) return { el:null, count:0 };

    for(let i=list.length-1; i>=0; i--){
      const el = list[i];
      const rect = el.getBoundingClientRect();
      const visible = (el.offsetParent !== null) && rect.width > 0 && rect.height > 0;
      if(visible) return { el, count:list.length };
    }
    return { el:list[list.length-1], count:list.length };
  }

  function normRanks(x){
    return (x || "")
      .toUpperCase()
      .replace(/10/g,"T")
      .replace(/[^AKQJT98765432]/g,"");
  }

  function getVal(id){
    const p = pickVisibleById(id);
    return {
      v: p.el ? normRanks(p.el.value) : "",
      count: p.count
    };
  }

  function readHands(){
    const nS = getVal("nS"), nH = getVal("nH"), nD = getVal("nD"), nC = getVal("nC");
    const eS = getVal("eS"), eH = getVal("eH"), eD = getVal("eD"), eC = getVal("eC");
    const sS = getVal("sS"), sH = getVal("sH"), sD = getVal("sD"), sC = getVal("sC");
    const wS = getVal("wS"), wH = getVal("wH"), wD = getVal("wD"), wC = getVal("wC");

    return {
      hands: {
        N: { S:nS.v, H:nH.v, D:nD.v, C:nC.v },
        E: { S:eS.v, H:eH.v, D:eD.v, C:eC.v },
        S: { S:sS.v, H:sH.v, D:sD.v, C:sC.v },
        W: { S:wS.v, H:wH.v, D:wD.v, C:wC.v }
      },
      counts: {
        nS:nS.count, nH:nH.count, nD:nD.count, nC:nC.count,
        eS:eS.count, eH:eH.count, eD:eD.count, eC:eC.count,
        sS:sS.count, sH:sH.count, sD:sD.count, sC:sC.count,
        wS:wS.count, wH:wH.count, wD:wD.count, wC:wC.count
      }
    };
  }

  function validateDeal(hands){
    const seen = new Set();
    const problems = [];
    let total = 0;

    function add(seat, suit, ranks){
      for(const r of ranks){
        total++;
        const key = suit + r;
        if(seen.has(key)) problems.push(`Doppione: ${key} (seat ${seat})`);
        seen.add(key);
      }
    }

    const perSeat = {};
    for(const seat of ["N","E","S","W"]){
      const h = hands[seat];
      add(seat, "S", h.S);
      add(seat, "H", h.H);
      add(seat, "D", h.D);
      add(seat, "C", h.C);
      perSeat[seat] = h.S.length + h.H.length + h.D.length + h.C.length;
      if(perSeat[seat] !== 13) problems.push(`Seat ${seat}: ${perSeat[seat]} carte (attese 13)`);
    }

    const missing = [];
    for(const suit of ["S","H","D","C"]){
      for(const r of RANKS){
        const key = suit + r;
        if(!seen.has(key)) missing.push(key);
      }
    }

    const ok = (problems.length === 0 && total === 52 && missing.length === 0);
    return { ok, total, problems, missing, perSeat };
  }

  function seatPBN(sp, he, di, cl){
    return `${sp || "-"}.${he || "-"}.${di || "-"}.${cl || "-"}`;
  }
  function seatRAW(sp, he, di, cl){
    return `${sp}${he}${di}${cl}`;
  }

  function buildPBN(board, dealer, vul, N, E, S, W){
    const vulPbn = (vul==="o")?"None":(vul==="n")?"NS":(vul==="e")?"EW":"All";
    return `[Event "MK EasyHand"]\n[Board "${board}"]\n[Dealer "${dealer}"]\n[Vulnerable "${vulPbn}"]\n[Deal "N:${N} ${E} ${S} ${W}"]\n`;
  }

  function buildLIN(board, dealer, vul, Nraw, Wraw, Eraw, Sraw){
    const dealerIdx = ({S:"1",W:"2",N:"3",E:"4"})[dealer] || "3";
    return `pn|N,E,S,W|sv|${vul}|bd|${board}|md|${dealerIdx}${Nraw},${Wraw},${Eraw},${Sraw}|`;
  }

  const genBtn = $("genBtn");
  const genMsg = $("genMsg");
  const debug = $("debug");
  const outLIN = $("outLIN");
  const outPBN = $("outPBN");

  genBtn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();

    const { hands, counts } = readHands();

    debug.textContent =
      `DEBUG LETTURA:\n` +
      `N ♠=${hands.N.S} ♥=${hands.N.H} ♦=${hands.N.D} ♣=${hands.N.C}\n` +
      `E ♠=${hands.E.S} ♥=${hands.E.H} ♦=${hands.E.D} ♣=${hands.E.C}\n` +
      `S ♠=${hands.S.S} ♥=${hands.S.H} ♦=${hands.S.D} ♣=${hands.S.C}\n` +
      `W ♠=${hands.W.S} ♥=${hands.W.H} ♦=${hands.W.D} ♣=${hands.W.C}\n\n` +
      `ID duplicati (se >1 è il problema):\n` +
      `nS=${counts.nS} nH=${counts.nH} nD=${counts.nD} nC=${counts.nC}\n` +
      `eS=${counts.eS} eH=${counts.eH} eD=${counts.eD} eC=${counts.eC}\n` +
      `sS=${counts.sS} sH=${counts.sH} sD=${counts.sD} sC=${counts.sC}\n` +
      `wS=${counts.wS} wH=${counts.wH} wD=${counts.wD} wC=${counts.wC}\n`;

    const val = validateDeal(hands);
    if(!val.ok){
      genMsg.innerHTML = `<span class="bad">Validazione KO (tot=${val.total})</span>`;
      outLIN.value = "";
      outPBN.value = "";
      return;
    }

    genMsg.innerHTML = `<span class="ok">Validazione OK ✅</span>`;

    // per ora fisso (poi li agganciamo allo screenshot)
    const board="1", dealer="N", vul="o";

    const Npbn = seatPBN(hands.N.S, hands.N.H, hands.N.D, hands.N.C);
    const Epbn = seatPBN(hands.E.S, hands.E.H, hands.E.D, hands.E.C);
    const Spbn = seatPBN(hands.S.S, hands.S.H, hands.S.D, hands.S.C);
    const Wpbn = seatPBN(hands.W.S, hands.W.H, hands.W.D, hands.W.C);

    const Nraw = seatRAW(hands.N.S, hands.N.H, hands.N.D, hands.N.C);
    const Eraw = seatRAW(hands.E.S, hands.E.H, hands.E.D, hands.E.C);
    const Sraw = seatRAW(hands.S.S, hands.S.H, hands.S.D, hands.S.C);
    const Wraw = seatRAW(hands.W.S, hands.W.H, hands.W.D, hands.W.C);

    outPBN.value = buildPBN(board, dealer, vul, Npbn, Epbn, Spbn, Wpbn);
    outLIN.value = buildLIN(board, dealer, vul, Nraw, Wraw, Eraw, Sraw);
  });
</script>

</body>
</html>
