<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MK EasyHand ‚Äì RealBridge</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:20px; }
    h1 { font-size:22px; margin-top:0; }
    .box { background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; }
    textarea { width:100%; height:140px; font-family: monospace; font-size:14px; }
    button { padding:10px 15px; font-size:16px; border-radius:8px; border:none; background:#1976d2; color:#fff; cursor:pointer; }
    button:active { background:#0f4fa8; }
    button.gray { background:#555; }
    button.gray:active { background:#333; }
    img { max-width:100%; border-radius:10px; border:1px solid #ddd; }
    input, select { margin:3px 0; padding:6px; border-radius:6px; border:1px solid #ccc; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; background:#eef; font-size:12px; color:#334; }
    .ok { color:#0a7a2f; font-weight:bold; }
    .bad { color:#b00020; font-weight:bold; }
    small { color:#666; }
    pre { background:#f7f7f7; padding:10px; border-radius:8px; border:1px solid #eee; }
  </style>
</head>

<body>
<h1>MK EasyHand ‚Äì RealBridge (MVP)</h1>

<div class="box">
  <b>v1.1b</b> ‚Äî stabile: OCR viene caricato <b>solo</b> quando premi ‚ÄúLeggi Board/Dealer/Vul‚Äù.
</div>

<div class="box">
  <b>Test rapido</b>
  <textarea readonly>
Board 1
Dealer N
None Vul

N: ‚ô†AJ542 ‚ô•K6543 ‚ô¶64 ‚ô£9
E: ‚ô†973 ‚ô•10987 ‚ô¶8 ‚ô£AJ1053
S: ‚ô†K106 ‚ô•AQ ‚ô¶102 ‚ô£KQ7642
W: ‚ô†Q8 ‚ô•J2 ‚ô¶AKQJ9753 ‚ô£8
  </textarea>
</div>

<div class="row" style="margin-bottom:15px;">
  <button onclick="alert('Perfetto! L‚Äôapp √® viva üëç')">Test APP</button>
  <span class="pill">MVP</span>
</div>

<hr style="margin:20px 0; border:none; border-top:1px solid #ddd;">

<div class="box">
  <b>Carica uno screenshot RealBridge</b><br><br>
  <div class="row">
    <input id="imgInput" type="file" accept="image/*">
    <button id="readHeaderBtn" class="gray" type="button">Leggi Board/Dealer/Vul dallo screenshot</button>
  </div>
  <div id="imgMsg" style="margin-top:8px;"></div>
</div>

<div class="box">
  <b>Anteprima screenshot</b><br><br>
  <img id="imgPreview" style="display:none;">
</div>

<div class="box">
  <b>Dati board</b><br>
  <small>OCR riempie i campi se riesce. Altrimenti compila a mano.</small><br><br>
  <div class="row">
    <label>Board <input id="boardNo" style="width:90px" placeholder="es: 2"></label>
    <label>Dealer
      <select id="dealer">
        <option value="N">N</option>
        <option value="E">E</option>
        <option value="S">S</option>
        <option value="W">W</option>
      </select>
    </label>
    <label>Vul
      <select id="vul">
        <option value="o">None</option>
        <option value="n">NS</option>
        <option value="e">EW</option>
        <option value="b">All</option>
      </select>
    </label>
  </div>
  <div id="headerStatus" style="margin-top:8px;"></div>
</div>

<div class="box">
  <b>Inserisci mano (manuale)</b> <small>(usa 10 oppure T)</small><br><br>

  <b>NORD</b><br>
  ‚ô† <input id="nS"><br>
  ‚ô• <input id="nH"><br>
  ‚ô¶ <input id="nD"><br>
  ‚ô£ <input id="nC"><br><br>

  <b>EST</b><br>
  ‚ô† <input id="eS"><br>
  ‚ô• <input id="eH"><br>
  ‚ô¶ <input id="eD"><br>
  ‚ô£ <input id="eC"><br><br>

  <b>SUD</b><br>
  ‚ô† <input id="sS"><br>
  ‚ô• <input id="sH"><br>
  ‚ô¶ <input id="sD"><br>
  ‚ô£ <input id="sC"><br><br>

  <b>OVEST</b><br>
  ‚ô† <input id="wS"><br>
  ‚ô• <input id="wH"><br>
  ‚ô¶ <input id="wD"><br>
  ‚ô£ <input id="wC"><br><br>

  <div class="row">
    <button id="genBtn" type="button">Genera LIN / PBN (con validazione)</button>
    <span id="genMsg"></span>
  </div>
</div>

<div class="box">
  <b>Output LIN</b>
  <textarea id="outLIN" readonly></textarea>
</div>

<div class="box">
  <b>Output PBN</b>
  <textarea id="outPBN" readonly></textarea>
</div>

<div class="box">
  <b>Analisi didattica (rapida)</b>
  <div id="analysis" style="margin-top:10px;"></div>
</div>

<script>
/* ---------- Lazy load Tesseract ---------- */
let tesseractReady = false;

async function loadTesseract(){
  if(tesseractReady) return true;
  return new Promise((resolve) => {
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
    s.onload = () => { tesseractReady = true; resolve(true); };
    s.onerror = () => resolve(false);
    document.head.appendChild(s);
  });
}

/* ---------- Utils ---------- */
const RANKS = "AKQJT98765432";
const HCP = {A:4, K:3, Q:2, J:1};

function normRanks(x){
  return (x || "")
    .toUpperCase()
    .replace(/10/g,"T")
    .replace(/[^AKQJT98765432]/g,"");
}

function seatPBN(sp, he, di, cl){
  const S = sp || "-";
  const H = he || "-";
  const D = di || "-";
  const C = cl || "-";
  return `${S}.${H}.${D}.${C}`;
}

function seatRAW(sp, he, di, cl){ return `${sp}${he}${di}${cl}`; }

function buildPBN(board, dealer, vul, N, E, S, W){
  const vulPbn = (vul==="o")?"None":(vul==="n")?"NS":(vul==="e")?"EW":"All";
  return `[Event "MK EasyHand"]\n[Board "${board}"]\n[Dealer "${dealer}"]\n[Vulnerable "${vulPbn}"]\n[Deal "N:${N} ${E} ${S} ${W}"]\n`;
}

function buildLIN(board, dealer, vul, Nraw, Wraw, Eraw, Sraw){
  const dealerIdx = ({S:"1",W:"2",N:"3",E:"4"})[dealer] || "3";
  return `pn|N,E,S,W|sv|${vul}|bd|${board}|md|${dealerIdx}${Nraw},${Wraw},${Eraw},${Sraw}|`;
}

/* ---------- Validazione ---------- */
function validateDeal(hands){
  const seen = new Set();
  const problems = [];
  let total = 0;

  function add(seat, suit, ranks){
    for(const r of ranks){
      total++;
      const key = suit + r;
      if(seen.has(key)) problems.push(`Doppione: ${key} (seat ${seat})`);
      seen.add(key);
    }
  }

  const perSeat = {};
  for(const seat of ["N","E","S","W"]){
    const h = hands[seat];
    add(seat, "S", h.S);
    add(seat, "H", h.H);
    add(seat, "D", h.D);
    add(seat, "C", h.C);
    perSeat[seat] = h.S.length + h.H.length + h.D.length + h.C.length;
    if(perSeat[seat] !== 13) problems.push(`Seat ${seat}: ${perSeat[seat]} carte (attese 13)`);
  }

  const missing = [];
  for(const suit of ["S","H","D","C"]){
    for(const r of RANKS){
      const key = suit + r;
      if(!seen.has(key)) missing.push(key);
    }
  }

  const ok = (problems.length === 0 && total === 52 && missing.length === 0);
  return { ok, total, problems, missing, perSeat };
}

/* ---------- Analisi rapida ---------- */
function hcpOf(ranks){ let s=0; for(const r of ranks) s += (HCP[r]||0); return s; }
function seatHCP(h){ return hcpOf(h.S)+hcpOf(h.H)+hcpOf(h.D)+hcpOf(h.C); }
function suitLen(h,s){ return (h[s]||"").length; }

function suggest(hands){
  const hN=seatHCP(hands.N), hS=seatHCP(hands.S), hE=seatHCP(hands.E), hW=seatHCP(hands.W);
  const ns=hN+hS, ew=hE+hW;

  function bestFit(a,b){
    const out=[];
    for(const suit of ["S","H","D","C"]){
      out.push({suit, len: suitLen(a,suit)+suitLen(b,suit)});
    }
    out.sort((x,y)=>y.len-x.len);
    return out[0];
  }
  const fitNS=bestFit(hands.N,hands.S), fitEW=bestFit(hands.E,hands.W);

  function hint(points, fit){
    if(points>=25){
      if(fit.len>=8 && (fit.suit==="S"||fit.suit==="H")) return `Probabile manche a ${fit.suit} (fit ${fit.len})`;
      return `Probabile manche a SA (punti ${points})`;
    }
    if(points>=23) return `Invito (punti ${points})`;
    return `Parziale (punti ${points})`;
  }
  return {hcp:{N:hN,E:hE,S:hS,W:hW,NS:ns,EW:ew}, fitNS, fitEW, hintNS:hint(ns,fitNS), hintEW:hint(ew,fitEW)};
}

/* ---------- UI refs ---------- */
const imgInput = document.getElementById("imgInput");
const imgPreview = document.getElementById("imgPreview");
const imgMsg = document.getElementById("imgMsg");
const headerStatus = document.getElementById("headerStatus");
const boardNo = document.getElementById("boardNo");
const dealer = document.getElementById("dealer");
const vul = document.getElementById("vul");
const outLIN = document.getElementById("outLIN");
const outPBN = document.getElementById("outPBN");
const genMsg = document.getElementById("genMsg");
const analysis = document.getElementById("analysis");

let lastImage = null;

imgInput.addEventListener("change", () => {
  const f = imgInput.files && imgInput.files[0];
  if(!f){ lastImage=null; imgPreview.style.display="none"; imgMsg.textContent=""; return; }
  const url = URL.createObjectURL(f);
  imgPreview.src = url;
  imgPreview.style.display = "block";
  imgMsg.innerHTML = `<span class="ok">Screenshot caricato ‚úÖ</span>`;
  lastImage = imgPreview;
});

/* ---------- OCR header ---------- */
function normHeaderText(t){
  return (t||"").replace(/\r/g,"\n").toUpperCase();
}
function parseHeader(text){
  const t = normHeaderText(text);
  const b = (t.match(/BOARD\s*([0-9]{1,2})/)||[])[1] || "";
  const d = (t.match(/DEALER\s*([NESW])/)||[])[1] || "";
  let v = (t.match(/(NONE|NS|EW|ALL)\s*VUL/)||[])[1] || "";
  if(!v) v = (t.match(/(NONE|NS|EW|ALL)\s*VU?L/)||[])[1] || "";
  const map = {NONE:"o", NS:"n", EW:"e", ALL:"b"};
  return { board:b, dealer:d, vulCode: map[v]||"", vulRaw:v };
}

async function ocrHeaderFromImage(imgEl){
  const W = imgEl.naturalWidth, H = imgEl.naturalHeight;
  const x = Math.floor(W * 0.02);
  const y = Math.floor(H * 0.03);
  const w = Math.floor(W * 0.40);
  const h = Math.floor(H * 0.25);

  const c = document.createElement("canvas");
  c.width = w; c.height = h;
  const ctx = c.getContext("2d");
  ctx.drawImage(imgEl, x, y, w, h, 0, 0, w, h);

  const imgData = ctx.getImageData(0,0,w,h);
  const d = imgData.data;
  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    let yv = 0.2126*r + 0.7152*g + 0.0722*b;
    yv = (yv>200)?255:(yv<70?0:yv);
    d[i]=d[i+1]=d[i+2]=yv;
  }
  ctx.putImageData(imgData,0,0);

  const { data: { text } } = await Tesseract.recognize(c, "eng", {
    logger: m => {
      if(m.status === "recognizing text"){
        headerStatus.innerHTML = `OCR in corso‚Ä¶ ${(m.progress*100).toFixed(0)}%`;
      }
    }
  });
  return text;
}

document.getElementById("readHeaderBtn").addEventListener("click", async () => {
  if(!lastImage){
    headerStatus.innerHTML = `<span class="bad">Carica prima uno screenshot.</span>`;
    return;
  }
  headerStatus.innerHTML = "Carico OCR‚Ä¶";
  const ok = await loadTesseract();
  if(!ok){
    headerStatus.innerHTML = `<span class="bad">Impossibile caricare OCR (rete/CDN).</span> Inserisci Board/Dealer/Vul a mano.`;
    return;
  }

  try{
    headerStatus.innerHTML = "OCR in corso‚Ä¶";
    const text = await ocrHeaderFromImage(lastImage);
    const p = parseHeader(text);

    if(p.board) boardNo.value = p.board;
    if(p.dealer) dealer.value = p.dealer;
    if(p.vulCode) vul.value = p.vulCode;

    if(p.board && p.dealer && p.vulCode){
      headerStatus.innerHTML = `<span class="ok">Letto ‚úÖ</span> Board ${p.board} ‚Ä¢ Dealer ${p.dealer} ‚Ä¢ Vul ${p.vulRaw}`;
    }else{
      headerStatus.innerHTML = `<span class="bad">OCR parziale</span> (completa a mano).<br><pre>${text}</pre>`;
    }
  }catch(e){
    headerStatus.innerHTML = `<span class="bad">OCR fallito</span> (compila a mano).`;
  }
});

/* ---------- Generate + Validate + Analyze ---------- */
function readHands(){
  return {
    N: { S:normRanks(nS.value), H:normRanks(nH.value), D:normRanks(nD.value), C:normRanks(nC.value) },
    E: { S:normRanks(eS.value), H:normRanks(eH.value), D:normRanks(eD.value), C:normRanks(eC.value) },
    S: { S:normRanks(sS.value), H:normRanks(sH.value), D:normRanks(sD.value), C:normRanks(sC.value) },
    W: { S:normRanks(wS.value), H:normRanks(wH.value), D:normRanks(wD.value), C:normRanks(wC.value) }
  };
}

document.getElementById("genBtn").addEventListener("click", () => {
  const b = (boardNo.value || "1").replace(/[^0-9]/g,"") || "1";
  const d = dealer.value || "N";
  const v = vul.value || "o";

  const hands = readHands();
  const val = validateDeal(hands);

  if(!val.ok){
    genMsg.innerHTML = `<span class="bad">Validazione KO</span> (tot=${val.total})`;
    const probs = val.problems.slice(0,8).join("<br>");
    const miss = val.missing.slice(0,18).join(" ");
    analysis.innerHTML =
      `<div class="bad">‚ùå Mano non valida</div>
       <div><b>Carte per seat:</b> N=${val.perSeat.N}, E=${val.perSeat.E}, S=${val.perSeat.S}, W=${val.perSeat.W}</div>
       <div style="margin-top:8px;"><b>Problemi:</b><br>${probs || "‚Äî"}</div>
       <div style="margin-top:8px;"><b>Mancanti (prime 18):</b> ${miss}${val.missing.length>18 ? " ‚Ä¶" : ""}</div>
       <div style="margin-top:8px;"><small>Tipico: ‚Äú10‚Äù dimenticato (usa 10 o T), o carta duplicata.</small></div>`;
    outLIN.value = "";
    outPBN.value = "";
    return;
  }

  genMsg.innerHTML = `<span class="ok">Validazione OK ‚úÖ</span>`;

  const Npbn = seatPBN(hands.N.S, hands.N.H, hands.N.D, hands.N.C);
  const Epbn = seatPBN(hands.E.S, hands.E.H, hands.E.D, hands.E.C);
  const Spbn = seatPBN(hands.S.S, hands.S.H, hands.S.D, hands.S.C);
  const Wpbn = seatPBN(hands.W.S, hands.W.H, hands.W.D, hands.W.C);

  const Nraw = seatRAW(hands.N.S, hands.N.H, hands.N.D, hands.N.C);
  const Eraw = seatRAW(hands.E.S, hands.E.H, hands.E.D, hands.E.C);
  const Sraw = seatRAW(hands.S.S, hands.S.H, hands.S.D, hands.S.C);
  const Wraw = seatRAW(hands.W.S, hands.W.H, hands.W.D, hands.W.C);

  outPBN.value = buildPBN(b, d, v, Npbn, Epbn, Spbn, Wpbn);
  outLIN.value = buildLIN(b, d, v, Nraw, Wraw, Eraw, Sraw);

  const s = suggest(hands);
  analysis.innerHTML =
    `<div><b>HCP</b> ‚Äî N:${s.hcp.N} E:${s.hcp.E} S:${s.hcp.S} W:${s.hcp.W} ‚Äî <b>NS:${s.hcp.NS}</b> / <b>EW:${s.hcp.EW}</b></div>
     <div style="margin-top:8px;"><b>Fit NS:</b> ${s.fitNS.suit} (${s.fitNS.len}) ‚Ä¢ <b>Fit EW:</b> ${s.fitEW.suit} (${s.fitEW.len})</div>
     <div style="margin-top:8px;"><b>NS:</b> ${s.hintNS}</div>
     <div><b>EW:</b> ${s.hintEW}</div>`;
});
</script>

</body>
</html>
