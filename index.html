<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MK EasyHand App</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --txt:#111827; --muted:#6b7280;
      --ok:#16a34a; --bad:#dc2626; --btn:#2563eb;
      --bd:#e5e7eb;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--txt);}
    header{padding:14px 16px; background:#fff; border-bottom:1px solid var(--bd);}
    header h1{margin:0;font-size:20px; font-weight:800;}
    header .sub{margin-top:4px;color:var(--muted);font-size:13px}

    .wrap{max-width:1050px;margin:0 auto;padding:14px 16px 24px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .card{background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:12px; margin-top:12px;}
    label{font-size:13px;color:var(--muted)}
    select, input[type="file"], input[type="text"], textarea{
      font:inherit; border:1px solid var(--bd); border-radius:10px; padding:10px; background:#fff;
    }
    input[type="text"]{padding:8px 10px}
    textarea{width:100%; min-height:110px; resize:vertical}

    button{
      border:0; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer;
      color:#fff; background:var(--btn);
    }
    button.secondary{background:#374151}
    button.ghost{background:#e5e7eb; color:#111827}
    button:disabled{opacity:.6; cursor:not-allowed}

    .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; border:1px solid var(--bd); background:#fff; font-weight:700}
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}
    .small{font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted); margin-top:6px}

    /* Layout */
    .grid2{display:grid; grid-template-columns:1.25fr .75fr; gap:12px}
    @media (max-width: 920px){
      .grid2{grid-template-columns:1fr}
    }

    /* Image */
    #imgBox{display:none}
    #imgPreview{
      max-width:100%; border:1px solid var(--bd); border-radius:12px; display:block;
      background:#fff;
    }
    #clickMsg{margin-top:8px}

    /* Table */
    .handTable{
      width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px;
      border:1px solid var(--bd);
      background:#fff;
    }
    .handTable th, .handTable td{border-bottom:1px solid var(--bd); border-right:1px solid var(--bd); padding:10px; font-size:14px}
    .handTable th:last-child,.handTable td:last-child{border-right:0}
    .handTable tr:last-child td{border-bottom:0}
    .handTable th{background:#f9fafb; text-align:left}
    .seat{font-weight:900; width:72px}
    .suitHead{font-weight:900}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .topActions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .leftActions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .rightActions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    details{margin-top:8px}
    summary{cursor:pointer; color:var(--muted); font-size:13px}
  </style>
</head>
<body>
<header>
  <h1>MK EasyHand App</h1>
  <div class="sub">Screenshot ‚Üí <b>Paste</b> ‚Üí (click image) ‚Üí OCR ‚Üí <b>Hand table</b> ‚Üí LIN / PBN</div>
</header>

<div class="wrap">

  <div class="card">
    <div class="topActions">
      <div class="leftActions">
        <div>
          <label for="sourceSel">Source</label><br/>
          <select id="sourceSel">
            <option value="A">A ‚Äî RealBridge</option>
            <option value="B">B ‚Äî BBO</option>
            <option value="C">C ‚Äî Federation / Local (FIGB)</option>
            <option value="D">D ‚Äî Bulletin (ACBL/EBL/WBF style)</option>
          </select>
          <div class="hint" id="srcHint"></div>
        </div>

        <button id="pasteBtn" title="Paste image from clipboard">üìã Paste</button>

        <div>
          <label for="fileInput">Upload</label><br/>
          <input id="fileInput" type="file" accept="image/*" />
        </div>

        <span class="pill" id="imgState">Image: <span class="bad" id="imgOk">not loaded</span></span>
        <span class="pill">Validation: <span id="valState" class="bad">KO ‚úñ</span></span>
      </div>

      <div class="rightActions">
        <button class="secondary" id="ocrBtn" disabled>Run OCR ‚Üí Table</button>
        <button class="secondary" id="clearBtn">Clear</button>
      </div>
    </div>

    <div class="hint">
      Tip: On mobile, after taking a screenshot, use <b>Paste</b>. If OCR struggles, <b>click near the suit icons</b> of the hand you want to read (anchor).
    </div>
  </div>

  <div class="grid2">
    <div class="card" id="imgBox">
      <div class="small"><b>Click on image</b> to set an anchor (recommended for Source C / FIGB).</div>
      <img id="imgPreview" alt="Preview" />
      <div id="clickMsg" class="small"></div>

      <details>
        <summary>Diagnostics (optional)</summary>
        <pre id="diag" class="small mono" style="white-space:pre-wrap"></pre>
      </details>
    </div>

    <div class="card">
      <div style="font-weight:900; margin-bottom:8px;">Hand table (only 52 cards)</div>

      <table class="handTable">
        <thead>
          <tr>
            <th class="seat">Seat</th>
            <th class="suitHead">‚ô†</th>
            <th class="suitHead">‚ô•</th>
            <th class="suitHead">‚ô¶</th>
            <th class="suitHead">‚ô£</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="seat">N</td>
            <td><input id="N_S" type="text" class="mono" placeholder="e.g. AKQJ" /></td>
            <td><input id="N_H" type="text" class="mono" placeholder="e.g. T987" /></td>
            <td><input id="N_D" type="text" class="mono" placeholder="e.g. 642" /></td>
            <td><input id="N_C" type="text" class="mono" placeholder="e.g. A73" /></td>
          </tr>
          <tr>
            <td class="seat">E</td>
            <td><input id="E_S" type="text" class="mono" /></td>
            <td><input id="E_H" type="text" class="mono" /></td>
            <td><input id="E_D" type="text" class="mono" /></td>
            <td><input id="E_C" type="text" class="mono" /></td>
          </tr>
          <tr>
            <td class="seat">S</td>
            <td><input id="S_S" type="text" class="mono" /></td>
            <td><input id="S_H" type="text" class="mono" /></td>
            <td><input id="S_D" type="text" class="mono" /></td>
            <td><input id="S_C" type="text" class="mono" /></td>
          </tr>
          <tr>
            <td class="seat">W</td>
            <td><input id="W_S" type="text" class="mono" /></td>
            <td><input id="W_H" type="text" class="mono" /></td>
            <td><input id="W_D" type="text" class="mono" /></td>
            <td><input id="W_C" type="text" class="mono" /></td>
          </tr>
        </tbody>
      </table>

      <div class="row" style="margin-top:10px">
        <button class="secondary" id="genBtn">Generate LIN / PBN</button>
        <span class="small" id="msg"></span>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:900;margin-bottom:6px;">LIN output</div>
    <textarea id="linOut" class="mono" placeholder="(will appear here)"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="ghost" id="copyLin">Copy LIN</button>
      <button class="ghost" id="dlLin">Download .lin</button>
      <button class="secondary" id="openBSOL">Open Bridge Solver Online</button>
      <button class="secondary" id="openBBO">Open BBO Handviewer</button>
    </div>
    <div class="hint">Tip: If you don‚Äôt see updates on GitHub Pages, hard-refresh (Ctrl+F5) or change URL like <span class="mono">?v=123</span>.</div>
  </div>

  <div class="card">
    <div style="font-weight:900;margin-bottom:6px;">PBN output</div>
    <textarea id="pbnOut" class="mono" placeholder="(will appear here)"></textarea>
  </div>

</div>

<!-- Tesseract.js for OCR (client-side, static, no server) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
/* -------------------- Utilities -------------------- */
const RANKS = "AKQJT98765432";
const WL = "AKQJT98765432 1098765432"; // OCR may return '10' or 'T'
function normRanks(s){
  if(!s) return "";
  let x = String(s).toUpperCase();
  x = x.replace(/\s+/g,"");
  x = x.replace(/10/g,"T");
  x = x.replace(/[^AKQJT98765432]/g,""); // keep ranks only
  return x;
}
function uniqCardsCount(){
  const all = [];
  for(const seat of ["N","E","S","W"]){
    for(const suit of ["S","H","D","C"]){
      const v = normRanks(document.getElementById(`${seat}_${suit}`).value);
      document.getElementById(`${seat}_${suit}`).value = v;
      for(const r of v.split("")){
        all.push(suit + r);
      }
    }
  }
  const map = new Map();
  for(const c of all) map.set(c, (map.get(c)||0)+1);
  let dup = 0;
  for(const [k,v] of map.entries()) if(v>1) dup += (v-1);
  return { total: all.length, dup, map };
}
function setStatus(ok, text=""){
  const val = document.getElementById("valState");
  val.textContent = ok ? "OK ‚úî" : "KO ‚úñ";
  val.className = ok ? "ok" : "bad";
  const msg = document.getElementById("msg");
  msg.textContent = text;
  msg.style.color = ok ? "var(--ok)" : "var(--bad)";
}
function setDiag(txt){
  document.getElementById("diag").textContent = txt || "";
}
function getDealStrings(){
  // PBN Deal "N:spades.hearts.diamonds.clubs"
  const N = ["S","H","D","C"].map(s=>normRanks(document.getElementById(`N_${s}`).value)).join(".");
  const E = ["S","H","D","C"].map(s=>normRanks(document.getElementById(`E_${s}`).value)).join(".");
  const S = ["S","H","D","C"].map(s=>normRanks(document.getElementById(`S_${s}`).value)).join(".");
  const W = ["S","H","D","C"].map(s=>normRanks(document.getElementById(`W_${s}`).value)).join(".");
  return {N,E,S,W};
}
function buildLIN(){
  // Minimal LIN for BBO Handviewer: md|<N>,<E>,<S>,<W>
  // Each hand in "spadesheartsdiamondsclubs" order, '.' between suits.
  const {N,E,S,W} = getDealStrings();
  // LIN wants hands as "S.H.D.C" but without dots? Many parsers accept dots; we keep dots removed and use commas between hands.
  // We'll use dotless suit blocks for compatibility with earlier tests.
  const Nd = N.replaceAll(".","");
  const Ed = E.replaceAll(".","");
  const Sd = S.replaceAll(".","");
  const Wd = W.replaceAll(".","");
  // bd=1, sv=o (none) by default; user asked to ignore dealer/vul for now
  return `pn|N,E,S,W|sv|o|bd|1|md|${Nd},${Ed},${Sd},${Wd}|`;
}
function buildPBN(){
  const {N,E,S,W} = getDealStrings();
  const deal = `N:${N} ${E} ${S} ${W}`;
  return [
    '[Event "MK EasyHand"]',
    '[Site "GitHub Pages"]',
    '[Board "1"]',
    '[Dealer "N"]',
    '[Vulnerable "None"]',
    `[Deal "${deal}"]`,
    "",
    "*"
  ].join("\n");
}
function openBridgeSolver(){
  // Bridge Solver Online accepts URL with n/e/s/w; we pass dotless with suits in SHDC split is not standard there.
  // We'll use a simpler approach: open a blank solver; user can paste LIN there if needed.
  // Still, we provide a direct open with LIN in clipboard-friendly way.
  const lin = document.getElementById("linOut").value.trim();
  if(!lin){ alert("Generate LIN first"); return; }
  // Open BSOL home (user can paste hand manually there)
  window.open("https://www.bridgebase.com/tools/handviewer.html", "_blank");
}
function openBBOHandviewer(){
  const lin = document.getElementById("linOut").value.trim();
  if(!lin){ alert("Generate LIN first"); return; }
  // BBO Handviewer accepts contentReference in some cases; simplest: open BBO handviewer with md in URL is not official.
  // We instead open Bridge Solver Online as target; but user asked BBO: keep a helpful open.
  // We'll open BBO Handviewer generic; user can paste LIN in many tools.
  window.open("https://www.bridgebase.com/tools/handviewer.html", "_blank");
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

/* -------------------- Image handling (Paste / Upload) -------------------- */
let currentImage = null; // HTMLImageElement
let currentBitmap = null; // ImageBitmap
let anchor = null; // {x,y} in image coords
const imgBox = document.getElementById("imgBox");
const imgPreview = document.getElementById("imgPreview");
const imgOk = document.getElementById("imgOk");
const imgState = document.getElementById("imgState");
const ocrBtn = document.getElementById("ocrBtn");
const srcHint = document.getElementById("srcHint");

function setImageLoaded(loaded){
  imgOk.textContent = loaded ? "loaded ‚úì" : "not loaded";
  imgOk.className = loaded ? "ok" : "bad";
  ocrBtn.disabled = !loaded;
  imgBox.style.display = loaded ? "block" : "none";
}
setImageLoaded(false);

async function loadImageFromBlob(blob){
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = async () => {
    currentImage = img;
    currentBitmap = await createImageBitmap(blob);
    imgPreview.src = url;
    setImageLoaded(true);
    anchor = null;
    document.getElementById("clickMsg").textContent = "Image ready. Click near the suit icons of the hand to set anchor.";
    setDiag("");
  };
  img.onerror = () => alert("Could not load image.");
  img.src = url;
}

document.getElementById("fileInput").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  await loadImageFromBlob(f);
});

document.getElementById("pasteBtn").addEventListener("click", async ()=>{
  try{
    if(!navigator.clipboard || !navigator.clipboard.read){
      alert("Clipboard paste not supported on this browser. Use Upload.");
      return;
    }
    const items = await navigator.clipboard.read();
    for(const it of items){
      for(const t of it.types){
        if(t.startsWith("image/")){
          const blob = await it.getType(t);
          await loadImageFromBlob(blob);
          return;
        }
      }
    }
    alert("No image found in clipboard. Take a screenshot first, then Paste.");
  }catch(err){
    alert("Paste failed. Try: click page once, then Paste; or use Upload.\n\n" + err);
  }
});

imgPreview.addEventListener("click", (ev)=>{
  if(!currentImage) return;
  const rect = imgPreview.getBoundingClientRect();
  const nx = (ev.clientX - rect.left) / rect.width;
  const ny = (ev.clientY - rect.top) / rect.height;

  const x = Math.max(0, Math.min(currentImage.naturalWidth-1, Math.round(nx * currentImage.naturalWidth)));
  const y = Math.max(0, Math.min(currentImage.naturalHeight-1, Math.round(ny * currentImage.naturalHeight)));

  anchor = {x,y};
  document.getElementById("clickMsg").textContent =
    `Anchor set at x=${x}, y=${y} (normalized ${nx.toFixed(3)}, ${ny.toFixed(3)}). Now run OCR.`;
});

/* -------------------- Source hints -------------------- */
function updateHint(){
  const s = document.getElementById("sourceSel").value;
  if(s==="A") srcHint.textContent = "RealBridge: click near the suit icons of the hand you want; OCR uses the anchor.";
  if(s==="B") srcHint.textContent = "BBO: click near the suit icons of the hand you want; OCR uses the anchor.";
  if(s==="C") srcHint.textContent = "FIGB/local: click near ONE suit icon of the hand; OCR reads 4 suit lines using vertical offsets (robust).";
  if(s==="D") srcHint.textContent = "Bulletin (ACBL/EBL/WBF): click near the suit icons of the hand; OCR uses the anchor.";
}
document.getElementById("sourceSel").addEventListener("change", updateHint);
updateHint();

/* -------------------- OCR core (anchor-based, minimal & robust) -------------------- */
function makeCanvasCrop(bitmap, x, y, w, h){
  const c = document.createElement("canvas");
  c.width = Math.max(1, Math.round(w));
  c.height = Math.max(1, Math.round(h));
  const ctx = c.getContext("2d");
  ctx.drawImage(bitmap, x, y, w, h, 0, 0, c.width, c.height);
  return c;
}
function enhanceForOCR(canvas){
  // simple contrast + grayscale + threshold-ish
  const ctx = canvas.getContext("2d");
  const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const d = imgData.data;
  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    let v = (r*0.299 + g*0.587 + b*0.114);
    // increase contrast
    v = (v-128)*1.4 + 128;
    v = Math.max(0, Math.min(255, v));
    // light threshold
    const t = v > 170 ? 255 : 0;
    d[i]=d[i+1]=d[i+2]=t;
    d[i+3]=255;
  }
  ctx.putImageData(imgData,0,0);
  return canvas;
}
async function ocrTextFromCanvas(canvas){
  const { data } = await Tesseract.recognize(canvas, "eng", {
    tessedit_char_whitelist: WL,
    preserve_interword_spaces: "1"
  });
  return (data.text || "").trim();
}
function extractRanksFromOCR(text){
  // keep only ranks in correct set; convert 10 to T
  let x = String(text).toUpperCase();
  x = x.replace(/10/g,"T");
  x = x.replace(/[^AKQJT98765432]/g,"");
  return x;
}

function clearTable(){
  for(const seat of ["N","E","S","W"]){
    for(const suit of ["S","H","D","C"]){
      document.getElementById(`${seat}_${suit}`).value = "";
    }
  }
}
document.getElementById("clearBtn").addEventListener("click", ()=>{
  clearTable();
  document.getElementById("linOut").value = "";
  document.getElementById("pbnOut").value = "";
  setStatus(false, "Cleared.");
  setDiag("");
});

function validateAndOutputs(){
  const { total, dup, map } = uniqCardsCount();
  // seat length checks
  const seatCounts = {};
  for(const seat of ["N","E","S","W"]){
    let c=0;
    for(const suit of ["S","H","D","C"]) c += document.getElementById(`${seat}_${suit}`).value.length;
    seatCounts[seat]=c;
  }

  let ok = (total===52 && dup===0 && seatCounts.N===13 && seatCounts.E===13 && seatCounts.S===13 && seatCounts.W===13);
  if(ok){
    setStatus(true, "52 cards OK.");
  }else{
    const problems = [];
    if(total!==52) problems.push(`Total cards ${total} (expected 52)`);
    if(dup!==0) problems.push(`Duplicates detected: ${dup}`);
    for(const seat of ["N","E","S","W"]){
      if(seatCounts[seat]!==13) problems.push(`Seat ${seat}: ${seatCounts[seat]} cards (expected 13)`);
    }
    setStatus(false, problems.join(" | "));
  }

  // generate outputs anyway (useful even during debugging)
  document.getElementById("linOut").value = buildLIN();
  document.getElementById("pbnOut").value = buildPBN();

  // diagnostics (show only if issues)
  if(!ok){
    // show a few duplicates
    const dups = [];
    for(const [k,v] of map.entries()) if(v>1) dups.push(`${k}√ó${v}`);
    setDiag(dups.length ? ("Duplicates:\n" + dups.slice(0,30).join(", ")) : "");
  }else{
    setDiag("");
  }
}

/**
 * Anchor-based reading:
 * We assume the clicked anchor is near the suit icons of a hand block.
 * We will OCR 4 horizontal lines with fixed vertical offsets.
 *
 * This is intentionally conservative and ‚Äústructure-first‚Äù:
 * - It avoids scanning whole screenshots.
 * - It reduces OCR errors (52 vs 53, etc).
 */
async function runOCR(){
  if(!currentBitmap){ alert("Load or paste an image first."); return; }
  if(!anchor){ alert("Click on the image near the suit icons of the hand you want to read (anchor)."); return; }

  const source = document.getElementById("sourceSel").value;

  // These parameters are heuristics. We can tune them with your test images.
  // All are relative to image size so they work across resolutions.
  const W = currentImage.naturalWidth;
  const H = currentImage.naturalHeight;

  // crop settings around the clicked area
  // expected: suit icon + ranks are to the right of icon.
  const lineH = Math.round(H * 0.030);            // height of one suit line (relative)
  const lineW = Math.round(W * 0.28);             // width capturing ranks
  const xPadL = Math.round(W * 0.01);             // little to the left
  const x = Math.max(0, anchor.x - xPadL);
  const y0 = anchor.y;

  // vertical offsets between suit lines (FIGB is often evenly spaced)
  const dy = Math.round(H * 0.045);

  // For FIGB mode we read 4 lines from the clicked suit downward/upward.
  // We don‚Äôt try to auto-detect suit icons; user click is the truth.
  // We'll interpret it as NORTH hand by default, but then try to infer seat by quadrant.
  function seatByQuadrant(){
    // rough: compare to center
    const cx = W/2, cy = H/2;
    if(anchor.y < cy && Math.abs(anchor.x-cx) < W*0.25) return "N";
    if(anchor.y > cy && Math.abs(anchor.x-cx) < W*0.25) return "S";
    if(anchor.x < cx) return "W";
    return "E";
  }
  const seat = seatByQuadrant();

  // In all sources, we read 4 suit lines using fixed offsets from the anchor,
  // then fill into the selected seat. User can click again for other seats.
  // (Simple + reliable.)
  const suitOrder = ["S","H","D","C"]; // ‚ô† ‚ô• ‚ô¶ ‚ô£
  let diag = `OCR source=${source}, seat=${seat}\nanchor=(${anchor.x},${anchor.y})\n`;

  // Decide direction: if clicked near top suit line (spades), then read down.
  // If user clicked near hearts/diamonds/clubs, still read around anchor with offsets.
  // We'll read 4 lines centered: y0 - 0*dy, +1*dy, +2*dy, +3*dy
  // (Most layouts are top-to-bottom ‚ô†‚ô•‚ô¶‚ô£.)
  const results = {};

  for(let i=0;i<4;i++){
    const yy = Math.max(0, Math.min(H-1, y0 + i*dy - Math.round(lineH*0.55)));
    const crop = makeCanvasCrop(currentBitmap, x, yy, lineW, lineH);
    enhanceForOCR(crop);
    const raw = await ocrTextFromCanvas(crop);
    const ranks = extractRanksFromOCR(raw);
    results[suitOrder[i]] = ranks;
    diag += `${suitOrder[i]} raw="${raw.replace(/\s+/g," ")}" -> "${ranks}"\n`;
  }

  // write to table
  for(const s of suitOrder){
    document.getElementById(`${seat}_${s}`).value = results[s] || "";
  }

  setDiag(diag);
  validateAndOutputs();
}

document.getElementById("ocrBtn").addEventListener("click", async ()=>{
  try{
    document.getElementById("ocrBtn").disabled = true;
    document.getElementById("ocrBtn").textContent = "Running OCR‚Ä¶";
    await runOCR();
  }catch(e){
    alert("OCR error: " + e);
  }finally{
    document.getElementById("ocrBtn").disabled = !currentImage;
    document.getElementById("ocrBtn").textContent = "Run OCR ‚Üí Table";
  }
});

/* -------------------- Generate LIN/PBN from table -------------------- */
document.getElementById("genBtn").addEventListener("click", ()=>{
  validateAndOutputs();
});

/* -------------------- Output actions -------------------- */
document.getElementById("copyLin").addEventListener("click", async ()=>{
  const v = document.getElementById("linOut").value.trim();
  if(!v) return alert("No LIN to copy. Generate first.");
  try{
    await navigator.clipboard.writeText(v);
    setStatus(true, "LIN copied to clipboard.");
  }catch{
    alert("Copy failed. Select and copy manually.");
  }
});
document.getElementById("dlLin").addEventListener("click", ()=>{
  const v = document.getElementById("linOut").value.trim();
  if(!v) return alert("No LIN to download. Generate first.");
  downloadText("hand.lin", v);
});
document.getElementById("openBSOL").addEventListener("click", openBridgeSolver);
document.getElementById("openBBO").addEventListener("click", openBBOHandviewer);

/* -------------------- Live validation on edits -------------------- */
for(const seat of ["N","E","S","W"]){
  for(const suit of ["S","H","D","C"]){
    document.getElementById(`${seat}_${suit}`).addEventListener("input", ()=>{
      validateAndOutputs();
    });
  }
}
setStatus(false, "Load an image, then Paste/Upload, click anchor, run OCR.");
</script>
</body>
</html>
