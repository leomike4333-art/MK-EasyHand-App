<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MK EasyHand ‚Äì Bridge ‚Üí LIN / PBN</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --ink:#111827; --muted:#6b7280; --ok:#16a34a; --bad:#dc2626; --btn:#111827; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;background:var(--bg);color:var(--ink);margin:0}
    header{padding:18px 16px 8px}
    h1{margin:0 0 4px;font-size:22px}
    .sub{color:var(--muted);font-size:13px}
    .wrap{max-width:1100px;margin:0 auto;padding:0 12px 18px}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;background:var(--card);border-radius:14px;padding:12px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .bar .sp{flex:1}
    select,input[type="text"]{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
    button{border:0;border-radius:12px;padding:10px 12px;font-weight:600;cursor:pointer}
    .btn{background:var(--btn);color:#fff}
    .btn2{background:#2563eb;color:#fff}
    .btn3{background:#ef4444;color:#fff}
    .btnOk{background:var(--ok);color:#fff}
    .pill{padding:6px 10px;border-radius:999px;background:#eef2ff;color:#1f2937;font-size:12px;font-weight:600}
    .pill.ok{background:#dcfce7;color:#166534}
    .pill.bad{background:#fee2e2;color:#991b1b}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px;margin-top:12px}
    .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .card h2{margin:0 0 10px;font-size:14px}
    #imgWrap{display:flex;justify-content:center;align-items:center;min-height:320px;border:1px dashed #d1d5db;border-radius:12px;background:#fafafa}
    #imgPreview{max-width:100%;max-height:70vh;display:none}
    .hint{color:var(--muted);font-size:12px;line-height:1.35;margin-top:6px}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;border:1px solid #e5e7eb}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px 10px;font-size:13px}
    th{background:#f9fafb;text-align:left}
    tr:last-child td{border-bottom:0}
    .seat{font-weight:700;width:72px}
    .cell input{width:100%;box-sizing:border-box;padding:7px 8px;border:1px solid #d1d5db;border-radius:10px}
    .out{width:100%;min-height:110px;border:1px solid #d1d5db;border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12.5px}
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .small{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace,monospace;border:1px solid #d1d5db;border-bottom-width:2px;border-radius:6px;padding:1px 6px;background:#fff}
    @media (max-width: 880px){
      .grid{grid-template-columns:1fr}
      #imgWrap{min-height:240px}
    }
  </style>
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js" defer></script>
</head>
<body>
  <header class="wrap">
    <h1>MK EasyHand App</h1>
    <div class="sub">Screenshot ‚Üí <b>Paste</b> / Upload ‚Üí <b>Auto OCR</b> ‚Üí (se serve) correggi in tabella ‚Üí <b>Generate LIN / PBN</b> ‚Üí Open Bridge Solver / BBO</div>
  </header>

  <main class="wrap">
    <div class="bar">
      <label class="pill">Source</label>
      <select id="sourceSel">
        <option value="BBO">B ‚Äî BBO</option>
        <option value="REALBRIDGE">A ‚Äî RealBridge</option>
        <option value="MYFIGB" selected>C ‚Äî Federation / Local (MYFIGB)</option>
        <option value="BULLETIN">D ‚Äî Bulletin / PDF diagram</option>
      </select>

      <button id="pasteBtn" class="btn2">üìã Paste</button>

      <label class="btn" style="padding:0;overflow:hidden">
        <span style="display:inline-block;padding:10px 12px;">Scegli file</span>
        <input id="fileInput" type="file" accept="image/*" style="display:none" />
      </label>

      <span id="imgStatus" class="pill">Image: none</span>
      <span id="valStatus" class="pill bad">Validation: KO ‚úñ</span>

      <span class="sp"></span>

      <button id="autoBtn" class="btnOk">‚ö° Auto OCR</button>
      <button id="genBtn" class="btn">Generate LIN / PBN</button>
      <button id="clearBtn" class="btn3">Clear</button>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="hint">
        Regola standard: premi <b>Auto OCR</b>. Se non √® perfetto, <b>correggi a mano nella tabella</b> (controllo qualit√†) e poi genera comunque il LIN.<br/>
        Tip cache GitHub Pages: <span class="kbd">Ctrl</span>+<span class="kbd">F5</span> oppure aggiungi <span class="kbd">?v=123</span> all‚ÄôURL.
      </div>
      <div id="progress" class="small" style="margin-top:8px"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Image</h2>
        <div id="imgWrap">
          <img id="imgPreview" alt="preview" />
        </div>
        <div class="hint">Suggerimento: per migliorare l‚ÄôOCR, fai uno screenshot ‚Äúpulito‚Äù (senza popup), ben centrato, e con zoom sufficiente.</div>
      </div>

      <div class="card">
        <h2>Hand table (52 cards) ‚Äî solo carte</h2>
        <table>
          <thead>
            <tr>
              <th class="seat">Seat</th>
              <th>‚ô†</th><th>‚ô•</th><th>‚ô¶</th><th>‚ô£</th>
            </tr>
          </thead>
          <tbody id="handBody"></tbody>
        </table>
        <div class="hint">Valori ammessi: AKQJT98765432 (10 = T). Spazi ignorati.</div>

        <div style="margin-top:12px">
          <div class="small"><b>LIN output</b></div>
          <textarea id="linOut" class="out" placeholder="(will appear here)"></textarea>
        </div>
        <div style="margin-top:10px">
          <div class="small"><b>PBN output</b></div>
          <textarea id="pbnOut" class="out" placeholder="(will appear here)"></textarea>
        </div>

        <div class="rowBtns">
          <button id="copyLinBtn" class="btn">Copy LIN</button>
          <button id="dlLinBtn" class="btn">Download .lin</button>
          <button id="openBsoBtn" class="btn">Open Bridge Solver Online</button>
          <button id="openBboBtn" class="btn">Open BBO Handviewer</button>
        </div>
      </div>
    </div>
  </main>

<script>
(() => {
  const SEATS = ["North","East","South","West"];
  const SUITS = ["S","H","D","C"];
  const RANKS = "AKQJT98765432";

  const handBody = document.getElementById("handBody");
  const imgPreview = document.getElementById("imgPreview");
  const imgStatus = document.getElementById("imgStatus");
  const valStatus = document.getElementById("valStatus");
  const progressEl = document.getElementById("progress");

  const sourceSel = document.getElementById("sourceSel");
  const pasteBtn = document.getElementById("pasteBtn");
  const fileInput = document.getElementById("fileInput");
  const autoBtn = document.getElementById("autoBtn");
  const genBtn = document.getElementById("genBtn");
  const clearBtn = document.getElementById("clearBtn");

  const linOut = document.getElementById("linOut");
  const pbnOut = document.getElementById("pbnOut");
  const copyLinBtn = document.getElementById("copyLinBtn");
  const dlLinBtn = document.getElementById("dlLinBtn");
  const openBsoBtn = document.getElementById("openBsoBtn");
  const openBboBtn = document.getElementById("openBboBtn");

  const inputs = {};
  function buildTable(){
    handBody.innerHTML = "";
    SEATS.forEach(seat => {
      const tr = document.createElement("tr");
      const tdSeat = document.createElement("td");
      tdSeat.className="seat";
      tdSeat.textContent = seat;
      tr.appendChild(tdSeat);
      inputs[seat] = {};
      SUITS.forEach(s => {
        const td = document.createElement("td");
        td.className="cell";
        const inp = document.createElement("input");
        inp.autocomplete="off";
        inp.spellcheck=false;
        inp.addEventListener("input", () => { normalizeAll(); validateAndRender(); });
        td.appendChild(inp);
        tr.appendChild(td);
        inputs[seat][s]=inp;
      });
      handBody.appendChild(tr);
    });
  }

  function setPill(pill, ok, text){
    pill.classList.remove("ok","bad");
    pill.classList.add(ok ? "ok":"bad");
    pill.textContent = text;
  }

  function normalizeRanks(str){
    if(!str) return "";
    let t = (""+str).toUpperCase().replaceAll("10","T");
    t = t.replace(new RegExp(`[^${RANKS}]`, "g"), "");
    let out = "";
    for(const ch of t){ if(!out.includes(ch)) out += ch; }
    return out;
  }

  function normalizeAll(){
    for(const seat of SEATS){
      for(const s of SUITS){
        const inp = inputs[seat][s];
        const n = normalizeRanks(inp.value);
        if(inp.value !== n) inp.value = n;
      }
    }
  }

  function gather(){
    const deal = {};
    for(const seat of SEATS){
      deal[seat]={};
      for(const s of SUITS) deal[seat][s]=normalizeRanks(inputs[seat][s].value);
    }
    return deal;
  }

  function validateDeal(deal){
    const seen = new Set();
    let total = 0;
    const perSeat = {};
    const dups = [];
    for(const seat of SEATS){
      let seatCount = 0;
      for(const s of SUITS){
        const cards = deal[seat][s];
        total += cards.length;
        seatCount += cards.length;
        for(const r of cards){
          const key = s + r;
          if(seen.has(key)) dups.push(key);
          seen.add(key);
        }
      }
      perSeat[seat]=seatCount;
    }
    const okTotal = (total === 52);
    const okSeat = SEATS.every(seat => perSeat[seat] === 13);
    const okDup = (dups.length === 0);
    return { total, perSeat, dups, okTotal, okSeat, okDup, ok: okTotal && okSeat && okDup };
  }

  function dealToLIN(deal){
    const handStr = (seat) => `${deal[seat].S}.${deal[seat].H}.${deal[seat].D}.${deal[seat].C}.`;
    return `pn|N,E,S,W|sv|o|md|1${handStr("North")}${handStr("East")}${handStr("South")}${handStr("West")}|`;
  }

  function dealToPBN(deal){
    const handStr = (seat) => `${deal[seat].S}.${deal[seat].H}.${deal[seat].D}.${deal[seat].C}`;
    const dealLine = `N:${handStr("North")} ${handStr("East")} ${handStr("South")} ${handStr("West")}`;
    return [
      '[Event "MK EasyHand"]',
      '[Site "GitHub Pages"]',
      '[Dealer "N"]',
      '[Vulnerable "None"]',
      `[Deal "${dealLine}"]`
    ].join("\\n");
  }

  function validateAndRender(){
    const deal = gather();
    const v = validateDeal(deal);
    setPill(valStatus, v.ok, v.ok ? "Validation: OK ‚úì" : "Validation: KO ‚úñ");
    if(v.ok){
      linOut.value = dealToLIN(deal);
      pbnOut.value = dealToPBN(deal);
      progressEl.textContent = "";
    } else {
      progressEl.textContent = `Debug: total=${v.total} (52), N=${v.perSeat.North}, E=${v.perSeat.East}, S=${v.perSeat.South}, W=${v.perSeat.West}` + (v.dups.length ? ` | duplicates: ${v.dups.join(", ")}` : "");
    }
  }

  function clearAll(){
    for(const seat of SEATS) for(const s of SUITS) inputs[seat][s].value = "";
    linOut.value=""; pbnOut.value="";
    progressEl.textContent="";
    setPill(valStatus, False, "Validation: KO ‚úñ");
  }

  // Image
  let currentImage=null;
  let imageCanvas=document.createElement("canvas");
  let ctx=imageCanvas.getContext("2d",{willReadFrequently:true});

  async function loadImageFromBlob(blob){
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => {
      currentImage = img;
      imgPreview.src = url;
      imgPreview.style.display = "block";
      imgStatus.classList.add("ok");
      imgStatus.textContent = "Image: loaded ‚úì";
      imageCanvas.width = img.naturalWidth;
      imageCanvas.height = img.naturalHeight;
      ctx.drawImage(img,0,0);
    };
    img.onerror = () => setPill(imgStatus,false,"Image: error");
    img.src = url;
  }

  pasteBtn.addEventListener("click", async () => {
    try{
      const items = await navigator.clipboard.read();
      for(const item of items){
        const t = (item.types||[]).find(x => x.startsWith("image/"));
        if(t){
          const blob = await item.getType(t);
          await loadImageFromBlob(blob);
          return;
        }
      }
      alert("Nessuna immagine negli appunti.");
    } catch(e){
      alert("Clipboard non accessibile. Prova con upload file.");
      console.error(e);
    }
  });

  fileInput.addEventListener("change", async (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    await loadImageFromBlob(f);
  });

  clearBtn.addEventListener("click", () => {
    for(const seat of SEATS) for(const s of SUITS) inputs[seat][s].value = "";
    linOut.value=""; pbnOut.value="";
    progressEl.textContent="";
    setPill(valStatus,false,"Validation: KO ‚úñ");
  });

  // OCR helpers
  function rectFromRel(rx1,ry1,rx2,ry2){
    const w=imageCanvas.width, h=imageCanvas.height;
    const x=Math.max(0,Math.floor(rx1*w));
    const y=Math.max(0,Math.floor(ry1*h));
    const ww=Math.max(1,Math.floor((rx2-rx1)*w));
    const hh=Math.max(1,Math.floor((ry2-ry1)*h));
    return {x,y,w:ww,h:hh};
  }
  function cropToCanvas(r){
    const c=document.createElement("canvas");
    c.width=r.w; c.height=r.h;
    const cctx=c.getContext("2d");
    cctx.drawImage(imageCanvas,r.x,r.y,r.w,r.h,0,0,r.w,r.h);
    return c;
  }
  async function ocrCanvas(c,note){
    if(!window.Tesseract) throw new Error("Tesseract non caricato (attendi 2-3s e riprova).");
    progressEl.textContent = note || "OCR‚Ä¶";
    const res = await Tesseract.recognize(c,"eng",{
      tessedit_char_whitelist: "AKQJT98765432\\n ",
      tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK
    });
    return (res.data && res.data.text) ? res.data.text : "";
  }
  function linesToSuits(text){
    // Robustly extract suit lines from OCR text.
    // Works for cases like:
    //  - "‚ô†74\n‚ô•A943\n‚ô¶752\n‚ô£KJ94"
    //  - "‚ô†74 ‚ô•A943 ‚ô¶752 ‚ô£KJ94" (single line)
    //  - "S74 H A943 D752 C KJ94" (letters)
    const out={S:"",H:"",D:"",C:""};
    const t=(text||"").toUpperCase();

    // First try: suit-tagged extraction (best when OCR keeps suit icons/letters)
    const tagged = t
      .replace(/10/g,'T')
      .replace(/[‚ô†]/g,'S').replace(/[‚ô•]/g,'H').replace(/[‚ô¶]/g,'D').replace(/[‚ô£]/g,'C');
    const re=/([SHDC])\s*([AKQJT98765432]+)/g;
    let m, any=false;
    while((m=re.exec(tagged))){
      const suit=m[1], ranks=m[2];
      out[suit]=normalizeRanks(ranks);
      any=true;
    }
    if(any) return out;

    // Fallback: assume line order S/H/D/C
    const raw=t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    out.S=normalizeRanks(raw[0]||"");
    out.H=normalizeRanks(raw[1]||"");
    out.D=normalizeRanks(raw[2]||"");
    out.C=normalizeRanks(raw[3]||"");
    return out;
  }
  function getSeatRectsBySource(src){
    if(src==="BBO"||src==="REALBRIDGE"){
      return {
        North: rectFromRel(0.34,0.08,0.66,0.33),
        West:  rectFromRel(0.05,0.30,0.35,0.58),
        East:  rectFromRel(0.65,0.30,0.95,0.58),
        South: rectFromRel(0.34,0.57,0.66,0.88),
      };
    }
    if(src==="MYFIGB"){
      return {
        North: rectFromRel(0.33,0.18,0.67,0.42),
        West:  rectFromRel(0.06,0.33,0.34,0.60),
        East:  rectFromRel(0.66,0.33,0.94,0.60),
        South: rectFromRel(0.33,0.60,0.67,0.86),
      };
    }
    return {
      North: rectFromRel(0.33,0.10,0.67,0.35),
      West:  rectFromRel(0.07,0.32,0.34,0.60),
      East:  rectFromRel(0.66,0.32,0.93,0.60),
      South: rectFromRel(0.33,0.60,0.67,0.88),
    };
  }

  async function runAutoOCR(){
    if(!currentImage){ alert("Prima carica un‚Äôimmagine."); return; }
    for(const seat of SEATS) for(const s of SUITS) inputs[seat][s].value="";
    linOut.value=""; pbnOut.value="";
    setPill(valStatus,false,"Validation: KO ‚úñ");

    const src = sourceSel.value;
    const rects = getSeatRectsBySource(src);
    try{
      for(const seat of ["North","East","South","West"]){
        const c = cropToCanvas(rects[seat]);
        const text = await ocrCanvas(c, `OCR ${seat}‚Ä¶`);
        const suits = linesToSuits(text);
        inputs[seat].S.value=suits.S;
        inputs[seat].H.value=suits.H;
        inputs[seat].D.value=suits.D;
        inputs[seat].C.value=suits.C;
        normalizeAll();
        validateAndRender();
      }
      progressEl.textContent = "Auto OCR completato. Se validation √® KO, correggi a mano e poi Generate LIN / PBN.";
    } catch(err){
      console.error(err);
      progressEl.textContent = "Errore OCR: " + (err.message || err);
      alert("Errore OCR. Vedi Debug.");
    }
  }

  autoBtn.addEventListener("click", runAutoOCR);

  genBtn.addEventListener("click", () => {
    normalizeAll();
    const deal = gather();
    linOut.value = dealToLIN(deal);
    pbnOut.value = dealToPBN(deal);
    validateAndRender();
  });

  copyLinBtn.addEventListener("click", async () => {
    if(!linOut.value.trim()){ alert("LIN vuoto."); return; }
    await navigator.clipboard.writeText(linOut.value);
    progressEl.textContent = "LIN copiato.";
  });

  dlLinBtn.addEventListener("click", () => {
    const txt = linOut.value.trim();
    if(!txt){ alert("LIN vuoto."); return; }
    const blob = new Blob([txt],{type:"text/plain"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="hand.lin";
    a.click();
  });

  openBsoBtn.addEventListener("click", () => window.open("https://bridgesolveronline.com/","_blank"));
  openBboBtn.addEventListener("click", () => window.open("https://www.bridgebase.com/tools/handviewer.html","_blank"));

  buildTable();
  validateAndRender();
})();
</script>
</body>
</html>
